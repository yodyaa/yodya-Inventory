<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
               primary: '#174D27',
          secondary: '#CADEC3',
          }
        }
      }
    }
  </script>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <!-- your firebase-config.js ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≥‡∏´‡∏ô‡∏î firebase.initializeApp(...) ‡πÅ‡∏•‡∏∞ const db = firebase.database(); -->
  <script src="firebase-config.js"></script>
</head>

<body class="bg-gray-100 min-h-screen flex">
  <!-- Sidebar -->
  <aside class="w-64 bg-primary p-6">
    <h1 class="text-white text-md font-bold mb-6">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°‡∏Ñ‡∏∑‡∏ô & ‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</h1>
    <nav class="space-y-4">
      <a href="./Dashboard.html"      class="block bg-primary border border-secondary text-secondary py-2 px-4 rounded">‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a>
      <a href="./Report-show.html"    class="block bg-secondary text-primary             py-2 px-4 rounded">‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</a>
      <a href="./Team.html"           class="block bg-secondary text-primary             py-2 px-4 rounded">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡∏°</a>
      <a href="./Devices.html"        class="block bg-secondary text-primary             py-2 px-4 rounded">‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</a>
      <a href="./User.html"           class="block bg-secondary text-primary             py-2 px-4 rounded">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</a>
      <a href="./Setting.html"        class="block bg-secondary text-primary             py-2 px-4 rounded">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</a>
    </nav>
  </aside>

  <!-- Main content -->
  <main class="flex-1 p-6 space-y-8">
    <!-- Summary Boxes -->
    <div id="summaryBoxes" class="grid grid-cols-2 sm:grid-cols-5 gap-4"></div>

    <!-- ‡∏ó‡∏µ‡∏°‡πÅ‡∏•‡∏∞‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå -->
    <section>
      <h2 class="text-lg font-bold mb-4">‡∏ó‡∏µ‡∏°‡πÅ‡∏•‡∏∞‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h2>
      <div id="teamCards" class="grid grid-cols-4 gap-4"></div>
    </section>

    <!-- ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏∑‡∏ô -->
    <section>
      <h2 class="text-lg font-bold mb-4">‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏∑‡∏ô</h2>
      <div id="borrowCards" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>
    </section>
  </main>

  <script>
    const TIMEZONE = 'Asia/Bangkok';

    // Counters
    let countTeams       = 0;
    let countMembers     = 0;
    let countBorrowed    = 0;
    let countNotReturned = 0;

    // ‡πÄ‡∏Å‡πá‡∏ö‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏°‡∏ï‡∏≤‡∏° user
    let devicesByUser = {};

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï summaryBoxes
    function updateSummaryBoxes() {
      const countReturned = countBorrowed - countNotReturned;
      document.getElementById("summaryBoxes").innerHTML = `
        <div class="bg-white border rounded-lg p-4 text-center">
          <div class="text-lg font-bold">${countTeams}</div>
          <div class="text-sm">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡∏°</div>
        </div>
        <div class="bg-white border rounded-lg p-4 text-center">
          <div class="text-lg font-bold">${countMembers}</div>
          <div class="text-sm">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏•‡∏π‡∏Å‡∏ó‡∏µ‡∏°</div>
        </div>
        <div class="bg-white border rounded-lg p-4 text-center">
          <div class="text-lg font-bold">${countBorrowed}</div>
          <div class="text-sm">‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏°</div>
        </div>
        <div class="bg-white border rounded-lg p-4 text-center">
          <div class="text-lg font-bold">${countNotReturned}</div>
          <div class="text-sm">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏∑‡∏ô</div>
        </div>
        <div class="bg-white border rounded-lg p-4 text-center">
          <div class="text-lg font-bold">${countReturned}</div>
          <div class="text-sm">‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏•‡πâ‡∏ß</div>
        </div>
      `;
    }

    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå
    function fetchDevicesInfo() {
      return db.ref('devices').once('value').then(snap => {
        const map = {};
        snap.forEach(ch => {
          const d = ch.val();
          map[d.deviceId] = { name: d.deviceName, status: d.status };
        });
        return map;
      });
    }

    // Listener ‡∏Ç‡∏≠‡∏á teams ‚Üí ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ó‡∏µ‡∏° + ‡∏ô‡∏±‡∏ö countTeams, countMembers, countBorrowed
    db.ref('teams').on('value', teamsSnap => {
      fetchDevicesInfo().then(devMap => {
        const container = document.getElementById('teamCards');
        container.innerHTML = '';
        countTeams    = 0;
        countMembers  = 0;
        countBorrowed = 0;

        teamsSnap.forEach(ch => {
          const team = ch.val();
          countTeams++;

          // ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å
          const memberNames = team.members
            ? Object.values(team.members).map(m => m.name)
            : [];
          countMembers += memberNames.length;

          // ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏°‡∏à‡∏≤‡∏Å‡∏ó‡∏µ‡∏°
          const equips = team.equipments
            ? Object.values(team.equipments)
            : [];
          countBorrowed += equips.length;

          // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πå‡∏î
          const equipList = equips.map(id => {
            const info = devMap[id] || { name: '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏ä‡∏∑‡πà‡∏≠', status: '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞' };
            const isActive = info.status === '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
            const badgeClass = isActive
              ? 'bg-green-100 text-green-800'
              : 'bg-red-100 text-red-800';
            const label = isActive ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô' : '‡∏Ñ‡∏•‡∏±‡∏á‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå';
            const dot = isActive
              ? `<span class="inline-block w-2 h-2 mr-1 rounded-full bg-green-500 animate-pulse"></span>`
              : '';
            return `
              <li class="flex justify-between items-center">
                <span>${id} ‚Äì ${info.name}</span>
                <span class="flex items-center px-2 py-0.5 text-xs font-medium rounded ${badgeClass}">
                  ${dot}${label}
                </span>
              </li>`;
          }).join('');
          const equipHTML = equips.length
            ? `<ul class="list-none space-y-1 mt-1">${equipList}</ul>`
            : `<p class="text-sm italic text-gray-500 mt-1">‚Äì ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå ‚Äì</p>`;

          // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ó‡∏µ‡∏°
          const card = document.createElement('div');
          card.className = 'bg-white p-4 rounded shadow';
          card.innerHTML = `
            <h3 class="text-lg font-semibold mb-2">${team.name}</h3>
            <p class="text-sm"><span class="font-medium">‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤:</span> ${team.leader?.name || '-'}</p>
            <p class="text-sm mt-1"><span class="font-medium">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å:</span> ${memberNames.length ? memberNames.join(', ') : '-'}</p>
            <div class="mt-2">
              <span class="font-medium text-sm">‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå:</span>
              ${equipHTML}
            </div>`;
          container.appendChild(card);
        });

        updateSummaryBoxes();
      });
    });

    // Listener ‡∏Ç‡∏≠‡∏á devices ‚Üí ‡∏ô‡∏±‡∏ö countNotReturned + ‡∏Å‡∏•‡∏∏‡πà‡∏° devicesByUser
    db.ref('devices').on('value', snap => {
      countNotReturned = 0;
      devicesByUser    = {};

      snap.forEach(ch => {
        const d = ch.val();
        if (d.status === '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô') {
          countNotReturned++;
          if (d.lastUserId) {
            if (!devicesByUser[d.lastUserId]) {
              devicesByUser[d.lastUserId] = { name: d.lastUser, items: [] };
            }
            devicesByUser[d.lastUserId].items.push({ id: d.deviceId, name: d.deviceName });
          }
        }
      });

      renderBorrowed();
      updateSummaryBoxes();
    });

    // ‡πÄ‡∏£‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ú‡∏π‡πâ‡∏¢‡∏∑‡∏°
    function renderBorrowed() {
      const cont = document.getElementById('borrowCards');
      cont.innerHTML = '';
      Object.entries(devicesByUser).forEach(([uid, u]) => {
        const list = u.items.map(i => `‚Ä¢ ${i.id} : ${i.name}`).join('<br>');
        const card = document.createElement('div');
        card.className = 'bg-white p-4 rounded shadow';
        card.innerHTML = `
          <div class="flex justify-between items-center">
            <h3 class="font-semibold">${u.name}</h3>
            <button onclick="notifyOne(
                '${uid}',
                '${u.name}',
                '${u.items.map(i => `${i.id}:${i.name}`).join(',')}'
              )"
              class="bg-red-500 text-white px-3 py-1 rounded text-xs">üîî</button>
          </div>
          <div class="mt-2 text-sm">${list}</div>`;
        cont.appendChild(card);
      });
    }

    // ‡∏™‡πà‡∏á Flex ‡πÑ‡∏õ GAS
    function sendFlexToGAS(uid, flex, altText = "üìã ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö") {
      fetch('https://script.google.com/macros/s/AKfycbwMyWlJ3lu9oKdxIPWaZldMFKz9JcPF2Ugan4HQy8Lgq9nTT8kDsNRIgre3SpXgCqbB/exec', {
        method: 'POST',
        body: JSON.stringify({ userId: uid, flexContent: flex, altText })
      });
    }

    // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏£‡∏≤‡∏¢‡∏Ñ‡∏ô
    function notifyOne(uid, name, list) {
      const items = list.split(',').map(txt => `- ${txt}`);
      const contents = [
        { type: "text", text: "üîî ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå", weight: "bold", size: "lg", margin: "md" },
        { type: "text", text: name, size: "md", weight: "bold", margin: "md" },
        ...items.map(text => ({ type: "text", text, size: "sm", color: "#555555", wrap: true }))
      ];
      const flex = { type: "bubble", body: { type: "box", layout: "vertical", contents } };
      sendFlexToGAS(uid, flex, "üîî ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå");
    }
  </script>
</body>
</html>
