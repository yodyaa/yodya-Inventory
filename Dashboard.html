<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8">
  <title>Dashboard-‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
  <script src="firebase-config.js"></script>

</head>

<body class="bg-gray-100">

  <div class="flex min-h-screen">
    <!-- Side Nav -->
    <aside class="w-64 bg-[#174D27]  p-6">
      <h1 class="text-white text-md font-bold mb-6">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°‡∏Ñ‡∏∑‡∏ô & ‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</h1>
      <nav class="space-y-4">
        <a href="./Dashboard.html"
          class="block bg-[#174D27] border border-[#CADEC3] text-white py-2 px-4 rounded">‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a>
        <a href="./Devices.html" class="block bg-[#CADEC3] text-[#174D27] py-2 px-4 rounded">‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</a>
        <a href="./User.html" class="block bg-[#CADEC3] text-[#174D27] py-2 px-4 rounded">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</a>
      </nav>
      <div class="p-4 mt-10 rounded-lg bg-gray-900">
        <label class="block text-sm text-white text-center font-medium mb-4">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏∑‡∏ô</label>
        <input id="notifyTimeInput" type="time" class="w-full border mb-4 p-2 rounded">
        <div class="flex items-center space-x-2">
          <button id="setNotifyTimeBtn" class="w-full bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
          <button id="cancelNotifyBtn"  class="w-full bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        </div>
        <p id="scheduledTimeMsg" class="text-sm mt-2 text-yellow-400"></p>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 p-6">
      <div class="bg-white p-6 rounded-lg shadow-sm">

        <!-- Summary Boxes -->
        <div id="summaryBoxes" class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-8"></div>

        <!-- ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Ñ‡∏∑‡∏ô -->
        <h2 class="text-2xl font-bold mb-4">‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Ñ‡∏∑‡∏ô <span><button onclick="notifyAllNotReturned()" class="text-xs bg-[#174D27] text-white p-2 rounded">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button></span></h2>
        <div id="borrowCards" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-10"></div>

        <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏° -->
        <div class="border-2 border-slate-500 rounded-lg p-4">
          <h2 class="text-lg font-semibold mb-4">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°</h2>
          <!-- Filters -->
          <div class="grid grid-cols-1 sm:grid-cols-4 gap-4 mb-4">
            <div>
              <label class="block text-sm">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏ã‡πà‡∏≠‡∏°</label>
              <input id="filterDate" type="date" class="border p-1 rounded w-full">
            </div>
            <div>
              <label class="block text-sm">‡∏£‡∏´‡∏±‡∏™</label>
              <input id="filterId" type="text" placeholder="‡∏£‡∏´‡∏±‡∏™" class="border p-1 rounded w-full">
            </div>
            <div>
              <label class="block text-sm">‡∏ä‡∏∑‡πà‡∏≠</label>
              <input id="filterName" type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠" class="border p-1 rounded w-full">
            </div>
            <div>
              <label class="block text-sm">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
              <input id="filterStatus" type="text" placeholder="‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞" class="border p-1 rounded w-full">
            </div>
          </div>

          <!-- Table -->
          <table class="min-w-full table-fixed rounded-lg overflow-hidden">
            <thead class="bg-[#174D27] text-white">
              <tr>
                <th class="w-24 py-2 px-4 text-left text-white text-sm">‡∏£‡∏´‡∏±‡∏™</th>
                <th class="w-36 py-2 px-4 text-left text-white text-sm">‡∏ä‡∏∑‡πà‡∏≠</th>
                <th class="w-48 py-2 px-4 text-left text-white text-sm">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠</th>
                <th class="w-64 py-2 px-4 text-left text-white text-sm">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>
                <th class="w-32 py-2 px-4 text-left text-white text-sm">‡∏£‡∏π‡∏õ‡∏Å‡πà‡∏≠‡∏ô‡∏ã‡πà‡∏≠‡∏°</th>
                <th class="w-32 py-2 px-4 text-left text-white text-sm">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                <th class="w-48 py-2 px-4 text-left text-white text-sm">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
              </tr>
            </thead>
            <tbody id="repairList" class="bg-white divide-y divide-gray-200 text-sm"></tbody>
          </table>

          <!-- Footer: Rows-per-page & Pagination -->
          <div class="flex justify-between items-center mt-4">
            <div class="flex items-center">
              <label for="rowsPerPage" class="mr-2">‡πÅ‡∏™‡∏î‡∏á</label>
              <select id="rowsPerPage" class="border px-2 py-1 rounded mr-2">
                <option value="15">15</option>
                <option value="50">50</option>
                <option value="100">100</option>
              </select>
              <span>‡πÅ‡∏ñ‡∏ß‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤</span>
            </div>
            <div id="pagination" class="flex space-x-2"></div>
          </div>
        </div>

      </div>
    </main>
  </div>

  <!-- Detail Modal -->
  <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-lg w-11/12 md:w-1/2 p-6 relative">
      <button id="closeModal" class="absolute top-2 right-2 text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
      <div id="modalContent"></div>
    </div>
  </div>

  <!-- Image Modal -->
  <div id="imageModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
    <img id="modalImage" src="" class="max-w-full max-h-full rounded-lg shadow-lg">
  </div>

  <script>
 
    // State
    let devicesGrouped = {}, reportsData = [], currentPage = 1;
    let rowsPerPage = 15, countLoaners = 0, countBorrowedItems = 0;
    let countReported = 0, countSuccess = 0;

    // Helpers
    function formatDate(iso) {
      if (!iso) return "-";
      const d = new Date(iso);
      return `${String(d.getDate()).padStart(2, '0')}-${String(d.getMonth() + 1).padStart(2, '0')}-${d.getFullYear()}`;
    }
    function getStatusClass(s) {
      if (s === "‡∏£‡∏≠‡∏ã‡πà‡∏≠‡∏°") return "bg-red-500 text-white";
      if (s === "‡∏™‡πà‡∏á‡∏ã‡πà‡∏≠‡∏°") return "bg-yellow-300 text-black";
      if (s === "‡∏ã‡πà‡∏≠‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à") return "bg-green-500 text-white";
      return "bg-gray-300 text-black";
    }

    // Update summary cards
    function updateSummaryBoxes() {
      document.getElementById("summaryBoxes").innerHTML = `
        <div class="bg-white border rounded-lg p-4 text-center">
          <div class="text-2xl font-bold">${countLoaners}</div>
          <div class="text-sm">‡∏ú‡∏π‡πâ‡∏¢‡∏∑‡∏°</div>
        </div>
        <div class="bg-white border rounded-lg p-4 text-center">
          <div class="text-2xl font-bold">${countBorrowedItems}</div>
          <div class="text-sm">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏∑‡∏ô</div>
        </div>
        <div class="bg-white border rounded-lg p-4 text-center">
          <div class="text-2xl font-bold">${countReported}</div>
          <div class="text-sm">‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</div>
        </div>
        <div class="bg-white border rounded-lg p-4 text-center">
          <div class="text-2xl font-bold">${countSuccess}</div>
          <div class="text-sm">‡∏ã‡πà‡∏≠‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>
        </div>
      `;
    }

    // Real-time borrowed devices
    db.ref("devices").on("value", snap => {
      devicesGrouped = {}; countLoaners = 0; countBorrowedItems = 0;
      document.getElementById("borrowCards").innerHTML = "";
      snap.forEach(ch => {
        const d = ch.val();
        if (d.status === "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô" && d.lastUserId) {
          if (!devicesGrouped[d.lastUserId]) {
            devicesGrouped[d.lastUserId] = { user: d.lastUser, items: [] };
          }
          devicesGrouped[d.lastUserId].items.push({ id: d.deviceId, name: d.deviceName });
        }
      });
      countLoaners = Object.keys(devicesGrouped).length;
      countBorrowedItems = Object.values(devicesGrouped).reduce((a, b) => a + b.items.length, 0);
      for (let [uid, u] of Object.entries(devicesGrouped)) {
        const list = u.items.map(i => `${i.id} ${i.name}`).join(", ");
        const card = document.createElement("div");
        card.className = "border rounded-lg p-4 bg-white";
        card.innerHTML = `
          <div class="flex justify-between items-center">
            <h3 class="font-semibold">${u.user}</h3>
            <button onclick="notifyLine('${uid}','${u.user}','${list}')" class="bg-red-500 text-xs text-white px-3 py-1 rounded-full">‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</button>
          </div>
          <ul class="mt-2 text-sm space-y-1">
            ${u.items.map(i => `<li>‚Ä¢ ${i.id} : ${i.name}</li>`).join("")}
          </ul>
        `;
        document.getElementById("borrowCards").append(card);
      }
      updateSummaryBoxes();
    });

    // Real-time repair reports
    db.ref("repairReports").on("value", snap => {
      reportsData = []; countReported = 0; countSuccess = 0;
      snap.forEach(ch => {
        const r = ch.val(); reportsData.push({ id: ch.key, ...r });
        if (r.status === "‡∏™‡πà‡∏á‡∏ã‡πà‡∏≠‡∏°") countReported++;
        if (r.status === "‡∏ã‡πà‡∏≠‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à") countSuccess++;
      });
      reportsData.sort((a, b) => new Date(b.sendDate) - new Date(a.sendDate));
      updateSummaryBoxes();
      renderTablePage();
    });

    // Filters & pagination
    ["filterDate", "filterId", "filterName", "filterStatus"].forEach(id => {
      document.getElementById(id).addEventListener("input", () => { currentPage = 1; renderTablePage(); });
    });
    document.getElementById("rowsPerPage").addEventListener("change", e => {
      rowsPerPage = +e.target.value; currentPage = 1; renderTablePage();
    });

    function renderTablePage() {
      const fD = document.getElementById("filterDate").value;
      const fI = document.getElementById("filterId").value.trim();
      const fN = document.getElementById("filterName").value.trim();
      const fS = document.getElementById("filterStatus").value.trim();
      let arr = reportsData.filter(r => {
        if (fD && r.sendDate.split("T")[0] !== fD) return false;
        if (fI && !r.deviceId.includes(fI)) return false;
        if (fN && !r.deviceName.includes(fN)) return false;
        if (fS && !r.status.includes(fS)) return false;
        return true;
      });
      const tbody = document.getElementById("repairList");
      tbody.innerHTML = "";
      const start = (currentPage - 1) * rowsPerPage;
      arr.slice(start, start + rowsPerPage).forEach(r => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="py-2 px-4">${r.deviceId}</td>
          <td class="py-2 px-4">${r.deviceName}</td>
          <td class="py-2 px-4">${r.title}</td>
          <td class="py-2 px-4">${r.details}</td>
          <td class="py-2 px-4">
            ${r.imageUrl ? `<img src="${r.imageUrl}" class="h-16 rounded cursor-pointer" onclick="openImageModal('${r.imageUrl}')">` : "-"}
          </td>
          <td class="py-2 px-4"><span class="px-2 py-1 rounded-full ${getStatusClass(r.status)}">${r.status}</span></td>
          <td class="py-2 px-4 space-x-2">
            <button onclick="viewRepair('${r.id}')" class="px-3 py-1 bg-[#174D27] text-white rounded">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
            <button onclick="editRepair('${r.id}')" class="px-3 py-1 bg-[#CADEC3] text-[#174D27] rounded">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï</button>
            <button onclick="deleteRepair('${r.id}')" class="px-3 py-1 bg-red-500 text-white rounded">‡∏•‡∏ö</button>
          </td>

        `;
        tbody.appendChild(tr);
      });
      // pagination
      const total = Math.ceil(arr.length / rowsPerPage);
      const pg = document.getElementById("pagination"); pg.innerHTML = "";
      for (let i = 1; i <= total; i++) {
        const b = document.createElement("button");
        b.textContent = i; b.className = `px-3 py-1 rounded ${i === currentPage ? 'bg-[#174D27]  text-white' : 'bg-gray-300 text-black'}`;
        b.onclick = () => { currentPage = i; renderTablePage(); };
        pg.appendChild(b);
      }
    }

    // Detail modal controls
    const modal = document.getElementById("modal");
    document.getElementById("closeModal").onclick = () => {
      modal.classList.add("hidden");
      document.body.classList.remove("overflow-hidden");
    };
    window.addEventListener("click", e => {
      if (e.target === modal) {
        modal.classList.add("hidden");
        document.body.classList.remove("overflow-hidden");
      }
    });

    // View details
    function viewRepair(id) {
      db.ref("repairReports/" + id).once("value").then(snap => {
        const r = snap.val();
        document.getElementById("modalContent").innerHTML = `
          <h2 class="text-xl font-bold mb-4">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</h2>
          <p><strong>‡∏£‡∏´‡∏±‡∏™:</strong> ${r.deviceId}</p>
          <p><strong>‡∏ä‡∏∑‡πà‡∏≠:</strong> ${r.deviceName}</p>
          <p><strong>‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠:</strong> ${r.title}</p>
          <p><strong>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:</strong> ${r.details}</p>
          <p><strong>‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö:</strong> ${r.responsible || "-"}</p>
          <p><strong>‡∏™‡πà‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</strong> ${formatDate(r.sendDate)}</p>
          <p><strong>‡∏£‡∏π‡∏õ‡∏Å‡πà‡∏≠‡∏ô‡∏ã‡πà‡∏≠‡∏°:</strong><br>
            ${r.imageUrl
            ? `<img src="${r.imageUrl}" class="mt-2 max-w-48 rounded cursor-pointer" onclick="openImageModal('${r.imageUrl}')">`
            : "‡πÑ‡∏°‡πà‡∏°‡∏µ"}
          </p>
          <p><strong>‡∏£‡∏π‡∏õ‡∏´‡∏•‡∏±‡∏á‡∏ã‡πà‡∏≠‡∏°:</strong><br>
            ${r.imageAfter
            ? `<img src="${r.imageAfter}" class="mt-2 max-w-48 rounded cursor-pointer" onclick="openImageModal('${r.imageAfter}')">`
            : "‡πÑ‡∏°‡πà‡∏°‡∏µ"}
          </p>
        `;
        modal.classList.remove("hidden");
        document.body.classList.add("overflow-hidden");
      });
    }

    // Image modal
    function openImageModal(src) {
      const imgModal = document.getElementById("imageModal");
      const modalImg = document.getElementById("modalImage");
      modalImg.src = src;
      imgModal.classList.remove("hidden");
    }
    document.getElementById("imageModal").addEventListener("click", () => {
      document.getElementById("imageModal").classList.add("hidden");
    });

    // Edit / update
    function editRepair(id) {
      db.ref("repairReports/" + id).once("value").then(snap => {
        const d = snap.val();
        document.getElementById("modalContent").innerHTML = `
          <h2 class="text-xl font-bold mb-4">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°</h2>
          <form id="updateForm" class="space-y-3">
            <input type="hidden" id="repairId" value="${id}">
            <label class="block">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
            <select id="status" class="w-full p-2 border rounded">
              <option ${d.status === '‡∏£‡∏≠‡∏ã‡πà‡∏≠‡∏°' ? 'selected' : ''}>‡∏£‡∏≠‡∏ã‡πà‡∏≠‡∏°</option>
              <option ${d.status === '‡∏™‡πà‡∏á‡∏ã‡πà‡∏≠‡∏°' ? 'selected' : ''}>‡∏™‡πà‡∏á‡∏ã‡πà‡∏≠‡∏°</option>
              <option ${d.status === '‡∏ã‡πà‡∏≠‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' ? 'selected' : ''}>‡∏ã‡πà‡∏≠‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</option>
            </select>
            <label class="block">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</label>
            <input id="responsible" value="${d.responsible || ''}" class="w-full p-2 border rounded">
            <label class="block">‡∏™‡πà‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
            <input id="sendDate" type="date" value="${d.sendDate ? d.sendDate.split('T')[0] : ''}" class="w-full p-2 border rounded">
            <label class="block">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</label>
            <textarea id="solution" class="w-full p-2 border rounded">${d.solution || ''}</textarea>
            <label class="block">‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</label>
            <input id="cost" value="${d.cost || ''}" class="w-full p-2 border rounded">
            <label class="block">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏´‡∏•‡∏±‡∏á‡∏ã‡πà‡∏≠‡∏°</label>
            <input id="imageAfterFile" type="file" accept="image/*" class="w-full">
            <img id="afterPreview" src="${d.imageAfter || '#'}" class="mt-2 max-w-48 rounded ${d.imageAfter ? '' : 'hidden'}">
            <button type="submit" class="bg-[#174D27] text-right text-white px-4 py-2 mt-2 rounded">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
          </form>
        `;
        modal.classList.remove("hidden"); document.body.classList.add("overflow-hidden");

        // preview ‡∏´‡∏•‡∏±‡∏á‡∏ã‡πà‡∏≠‡∏°
        document.getElementById("imageAfterFile").onchange = e => {
          const file = e.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = ev => {
            const img = document.getElementById("afterPreview");
            img.src = ev.target.result; img.classList.remove("hidden");
          };
          reader.readAsDataURL(file);
        };

        // submit update form
        document.getElementById("updateForm").onsubmit = async e => {
          e.preventDefault();
          const id2 = document.getElementById("repairId").value;
          const newStatus = document.getElementById("status").value;
          const payload = {
            status: newStatus,
            responsible: document.getElementById("responsible").value,
            sendDate: document.getElementById("sendDate").value,
            solution: document.getElementById("solution").value,
            cost: document.getElementById("cost").value
          };
          // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡∏´‡∏•‡∏±‡∏á‡∏ã‡πà‡∏≠‡∏° ‡πÉ‡∏´‡πâ upload
          const file = document.getElementById("imageAfterFile").files[0];
            if (file) {
              // ‡∏™‡∏£‡πâ‡∏≤‡∏á reference ‡πÑ‡∏õ‡∏¢‡∏±‡∏á path ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
              const reportRef = storage.ref(`repair_after/${id2}`);
              // ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå
              const snap = await reportRef.put(file);
              // ‡∏î‡∏∂‡∏á URL ‡∏°‡∏≤‡πÉ‡∏ä‡πâ
              payload.imageAfter = await snap.ref.getDownloadURL();
            }
          
          // update report
          await db.ref("repairReports/" + id2).update(payload);

          // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô ‡∏ã‡πà‡∏≠‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÉ‡∏´‡πâ update devices status ‚Üí ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
          if (newStatus === "‡∏ã‡πà‡∏≠‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à") {
            const rpt = await db.ref("repairReports/" + id2).get();
            const devId = rpt.val().deviceId;
            await db.ref("devices/" + devId).update({ status: "‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô" });
          }

          alert("‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
          modal.classList.add("hidden");
          document.body.classList.remove("overflow-hidden");
        };
      });
    }

    function deleteRepair(id) {
      // ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏•‡∏ö
      if (!confirm('‚ùó ‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°‡∏ô‡∏µ‡πâ?')) return;
      // ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Firebase
      db.ref('repairReports/' + id).remove()
        .then(() => {
          alert('‚úÖ ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
          // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏ï‡∏≤‡∏£‡∏≤‡∏á
          renderTablePage();
          // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏£‡∏∏‡∏õ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô
          // Firebase listener ‡∏à‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏Å‡πá‡πÄ‡∏£‡∏µ‡∏¢‡∏Å:
          // updateSummaryBoxes();
        })
        .catch(err => {
          console.error('Error deleting report:', err);
          alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà');
        });
    }

    // Notify via LINE
    function notifyLine(userId, userName, list) {
      fetch("https://script.google.com/macros/s/AKfycbwMyWlJ3lu9oKdxIPWaZldMFKz9JcPF2Ugan4HQy8Lgq9nTT8kDsNRIgre3SpXgCqbB/exec", {
        method: "POST", mode: "no-cors",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ userId, message: `üì¶ ‡∏Ñ‡∏∏‡∏ì ${userName} ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå: ${list}` })
      });
    }
    function notifyAllNotReturned() {
      for (let [uid, u] of Object.entries(devicesGrouped))
        notifyLine(uid, u.user, u.items.map(i => i.id + " " + i.name).join(", "));
    }
    // Scheduler variables
    let scheduledTime = localStorage.getItem('notifyTime');
    const timeInput = document.getElementById('notifyTimeInput');
    const setBtn = document.getElementById('setNotifyTimeBtn');
    const cancelBtn = document.getElementById('cancelNotifyBtn');
    const msgEl = document.getElementById('scheduledTimeMsg');

    // Load saved time
    if (scheduledTime) {
      timeInput.value = scheduledTime;
      msgEl.textContent = `‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ ${scheduledTime}`;
    }

    // Set notify time
    setBtn.onclick = () => {
      const t = timeInput.value;
      if (!t) return alert('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤');
      localStorage.setItem('notifyTime', t);
      scheduledTime = t;
      msgEl.textContent = `‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ ${t}`;
    };

    // Cancel notify
    cancelBtn.onclick = () => {
      localStorage.removeItem('notifyTime');
      scheduledTime = null;
      timeInput.value = '';
      msgEl.textContent = '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß';
    };

    // Interval check
    setInterval(() => {
      if (!scheduledTime) return;
      const now = new Date();
      const hhmm = now.toTimeString().slice(0, 5);
      if (hhmm === scheduledTime) {
        notifyAllNotReturned();
      }
    }, 60000);

  </script>
</body>

</html>
