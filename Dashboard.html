<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#174D27',
            secondary: '#CADEC3',
          }
        }
      }
    }
  </script>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <!-- your firebase-config.js must initialize app and set `const db = firebase.database();` -->
  <script src="firebase-config.js"></script>
</head>

<body class="bg-gray-100 min-h-screen flex">
  <!-- Sidebar -->
  <aside class="w-64 bg-primary p-6">
    <h1 class="text-white text-md font-bold mb-6">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°‡∏Ñ‡∏∑‡∏ô & ‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</h1>
   <nav class="space-y-4">
      <a href="./Dashboard.html"      class="block bg-primary border border-secondary text-secondary py-2 px-4 rounded">‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a>
      <a href="./Report-show.html"    class="block bg-secondary text-primary             py-2 px-4 rounded">‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</a>
      <a href="./Team.html"           class="block bg-secondary text-primary             py-2 px-4 rounded">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡∏°</a>
      <a href="./Devices.html"        class="block bg-secondary text-primary             py-2 px-4 rounded">‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</a>
      <a href="./User.html"           class="block bg-secondary text-primary             py-2 px-4 rounded">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</a>
      <a href="./Setting.html"        class="block bg-secondary text-primary             py-2 px-4 rounded">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</a>
    </nav>
  </aside>

  <!-- Main content -->
  <main class="flex-1 p-6 space-y-8">
    <!-- Summary Boxes -->
    <div id="summaryBoxes" class="grid grid-cols-2 sm:grid-cols-5 gap-4"></div>

    <!-- ‡∏ó‡∏µ‡∏°‡πÅ‡∏•‡∏∞‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå -->
    <section>
      <h2 class="text-lg font-bold mb-4">‡∏ó‡∏µ‡∏°‡πÅ‡∏•‡∏∞‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h2>
      <div id="teamCards" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4"></div>
    </section>

    <!-- ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏∑‡∏ô -->
    <section>
      <h2 class="text-lg font-bold mb-4">‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏∑‡∏ô</h2>
      <div id="borrowCards" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>
    </section>
  </main>

  <script>
    const TIMEZONE = 'Asia/Bangkok';

    // Data holders
    let employees = {}, line2emp = {}, teamsSnap = null;
    let deviceMap = {}, devicesByUser = {};
    let countTeams = 0, countMembers = 0, countBorrowed = 0, countNotReturned = 0;

    // 1) Load employees ‚Üí build lineId‚ÜíempKey map
    db.ref('employees').on('value', snap => {
      employees = snap.val() || {};
      line2emp = {};
      Object.entries(employees).forEach(([empKey, emp]) => {
        if (emp.userIdLine) line2emp[emp.userIdLine] = empKey;
      });
      renderTeams();
    });

    // 2) Load teams snapshot
    db.ref('teams').on('value', snap => {
      teamsSnap = snap;
      renderTeams();
      updateSummaryBoxes();
    });

    // 3) Load devices ‚Üí build deviceMap and devicesByUser
    db.ref('devices').on('value', snap => {
      deviceMap = {};
      devicesByUser = {};
      countNotReturned = 0;

      snap.forEach(ch => {
        const d = ch.val(), id = ch.key;
        deviceMap[id] = {
          name: d.deviceName || d.name || '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏ä‡∏∑‡πà‡∏≠',
          status: d.status,
          lastUserId: d.lastUserId
        };
        if (d.status === '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô' && d.lastUserId) {
          countNotReturned++;
          if (!devicesByUser[d.lastUserId]) {
            devicesByUser[d.lastUserId] = { name: d.lastUser, items: [] };
          }
          devicesByUser[d.lastUserId].items.push({ id, name: deviceMap[id].name });
        }
      });

      renderBorrowed();
      renderTeams();
      updateSummaryBoxes();
    });

    // Render team cards, including both assigned and extra-borrowed equip
    function renderTeams() {
      if (!teamsSnap) return;
      const cont = document.getElementById('teamCards');
      cont.innerHTML = '';

      countTeams = 0;
      countMembers = 0;
      countBorrowed = 0;

      teamsSnap.forEach(ch => {
        const team = ch.val();
        const memberIds = team.members || [];
        countTeams++;
        countMembers += memberIds.length;

        // assigned equipments
        const assigned = (team.equipments || []).map(id => ({
          id,
          name: deviceMap[id]?.name || '‚Äì ‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏ä‡∏∑‡πà‡∏≠ ‚Äì',
          status: deviceMap[id]?.status
        }));
        countBorrowed += assigned.length;

        // extra borrowed by members that aren't in assigned
        const extra = [];
        Object.entries(devicesByUser).forEach(([lineId, u]) => {
          const empKey = line2emp[lineId];
          if (empKey === team.leader || memberIds.includes(empKey)) {
            u.items.forEach(item => {
              if (!assigned.some(a => a.id === item.id)) {
                extra.push({
                  id: item.id,
                  name: item.name,
                  status: deviceMap[item.id]?.status
                });
              }
            });
          }
        });

        const allEquip = [...assigned, ...extra];

        // build HTML
        let equipHTML;
        if (allEquip.length) {
          equipHTML = `<ul class="mt-1 space-y-1">` +
            allEquip.map(e => {
              const isActive = e.status === '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
              const badge    = isActive
                ? 'bg-green-100 text-green-800 animate-pulse'
                : 'bg-red-100 text-red-800';
              const label    = isActive ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô' : '‡∏Ñ‡∏•‡∏±‡∏á';
              const prefix   = assigned.some(a => a.id === e.id)
                ? ''
                : '<span class="text-xs text-blue-600 ml-1">(‡∏¢‡∏∑‡∏°‡πÄ‡∏Å‡∏¥‡∏ô)</span>';
              return `
                <li class="flex justify-between items-center">
                  <div>${e.id} ‚Äì ${e.name}${prefix}</div>
                  <span class="px-2 py-0.5 text-xs font-medium rounded ${badge}">${label}</span>
                </li>`;
            }).join('') +
          `</ul>`;
        } else {
          equipHTML = `<p class="italic text-gray-500">‚Äì ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå ‚Äì</p>`;
        }

        const leaderName  = employees[team.leader]?.fullName || '-';
        const memberNames = memberIds.map(id => employees[id]?.fullName || id).join(', ') || '-';

        const card = document.createElement('div');
        card.className = 'bg-white p-4 rounded shadow';
        card.innerHTML = `
          <h3 class="font-semibold mb-2">${team.name}</h3>
          <p><strong>‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤:</strong> ${leaderName}</p>
          <p class="mt-1"><strong>‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å:</strong> ${memberNames}</p>
          <div class="mt-2"><strong>‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå:</strong>${equipHTML}</div>`;
        cont.appendChild(card);
      });
    }

    // Render summary boxes
    function updateSummaryBoxes() {
      const countReturned = countBorrowed - countNotReturned;
      document.getElementById("summaryBoxes").innerHTML = `
        <div class="bg-white border rounded-lg p-4 text-center">
          <div class="text-lg font-bold">${countTeams}</div>
          <div class="text-sm">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡∏°</div>
        </div>
        <div class="bg-white border rounded-lg p-4 text-center">
          <div class="text-lg font-bold">${countMembers}</div>
          <div class="text-sm">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏•‡∏π‡∏Å‡∏ó‡∏µ‡∏°</div>
        </div>
        <div class="bg-white border rounded-lg p-4 text-center">
          <div class="text-lg font-bold">${countBorrowed}</div>
          <div class="text-sm">‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏°</div>
        </div>
        <div class="bg-white border rounded-lg p-4 text-center">
          <div class="text-lg font-bold">${countNotReturned}</div>
          <div class="text-sm">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏∑‡∏ô</div>
        </div>
        <div class="bg-white border rounded-lg p-4 text-center">
          <div class="text-lg font-bold">${countReturned}</div>
          <div class="text-sm">‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏•‡πâ‡∏ß</div>
        </div>
      `;
    }

    // Render borrowed-by-user cards
    function renderBorrowed() {
      const cont = document.getElementById('borrowCards');
      cont.innerHTML = '';
      Object.entries(devicesByUser).forEach(([uid, u]) => {
        const list = u.items.map(i => `‚Ä¢ ${i.id} : ${i.name}`).join('<br>');
        const card = document.createElement('div');
        card.className = 'bg-white p-4 rounded shadow';
        card.innerHTML = `
          <div class="flex justify-between items-center">
            <h3 class="font-semibold">${u.name}</h3>
            <button onclick="notifyOne('${uid}','${u.name}','${u.items.map(i=>`${i.id}:${i.name}`).join(',')}')"
                    class="bg-red-500 text-white px-3 py-1 rounded text-xs">üîî</button>
          </div>
          <div class="mt-2 text-sm">${list}</div>`;
        cont.appendChild(card);
      });
    }

    // Flex notify (unchanged)
    function sendFlexToGAS(uid, flex, altText="üìã ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö") {
      fetch('https://script.google.com/macros/s/AKfycbwMyWlJ3lu9oKdxIPWaZldMFKz9JcPF2Ugan4HQy8Lgq9nTT8kDsNRIgre3SpXgCqbB/exec', {
        method: 'POST',
        body: JSON.stringify({ userId: uid, flexContent: flex, altText })
      });
    }
    function notifyOne(uid, name, list) {
      const items = list.split(',').map(txt => `- ${txt}`);
      const contents = [
        { type: "text", text: "üîî ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå", weight: "bold", size: "lg", margin: "md" },
        { type: "text", text: name, size: "md", weight: "bold", margin: "md" },
        ...items.map(text => ({ type: "text", text, size: "sm", color: "#555555", wrap: true }))
      ];
      const flex = { type: "bubble", body: { type: "box", layout: "vertical", contents } };
      sendFlexToGAS(uid, flex, "üîî ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå");
    }
  </script>
</body>
</html>
