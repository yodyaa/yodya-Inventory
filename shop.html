<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8" />
  <title>ระบบคลังสินค้าอัจฉริยะ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
  <!-- jsQR for QR code scanning -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
  <!-- Your Firebase config -->
  <script src="firebase-config.js"></script>
  <style>
    /* Custom Alert Styles */
    #customAlert {
      transition: all 0.3s ease-in-out;
      transform: translateX(100%);
      opacity: 0;
    }

    #customAlert.show {
      transform: translateX(0);
      opacity: 1;
    }

    #customAlert.success {
      background-color: #10B981; /* Green-500 */
    }

    #customAlert.error {
      background-color: #EF4444; /* Red-500 */
    }

    /* Spinner animation */
    .spinner {
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid #fff;
      border-radius: 50%;
      width: 1.5rem;
      height: 1.5rem;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Active tab style */
    .tab-button.active {
      background-color: #174D27;
      border-color: #174D27;
      color: #c2dac9;
    }
  </style>
</head>

<body class="bg-gray-100 flex items-center justify-center p-4">

  <!-- Custom Alert Notification -->
  <div id="customAlert"
       class="fixed top-6 right-6 w-fit max-w-sm text-white px-5 py-3 rounded-lg shadow-xl text-center z-50 flex items-center justify-center space-x-2">
    <svg id="alertIcon" class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"></svg>
    <span id="alertMessage"></span>
  </div>

  <div class="w-full max-w-md mx-auto overflow-hidden">
    <!-- Tabs -->
    <div class="flex border-b border-gray-200 bg-gray-50">
      <button id="tabIssueBtn"
              class="tab-button flex-1 py-3 text-center border-b-2 border-[#174D27] active font-semibold text-[#174D27] transition-colors duration-200">
        เบิก
      </button>
      <button id="tabReceiveBtn"
              class="tab-button flex-1 py-3 text-center border-b-2 border-transparent text-gray-600 hover:text-[#174D27] hover:border-[#174D27] transition-colors duration-200">
        รับเข้า
      </button>
      <button id="tabHistoryBtn"
              class="tab-button flex-1 py-3 text-center border-b-2 border-transparent text-gray-600 hover:text-[#174D27] hover:border-[#174D27] transition-colors duration-200">
        ประวัติ
      </button>
    </div>

    <div class="py-6">
      <!-- เบิก (หลายรายการ) -->
      <div id="tabIssue">
        <div class="text-center mb-6">
          <h2 class="text-2xl font-extrabold text-gray-800">เบิกสินค้าหลายรายการ</h2>
          <p class="text-gray-600 mt-2">ผู้เบิก: <span id="actorIssue" class="font-semibold text-[#174D27]">–</span></p>
        </div>

        <button id="scanIssueBtn"
                class="w-full mb-4 bg-[#174D27] hover:bg-[#000000] text-white py-3 rounded-lg shadow-md flex items-center justify-center space-x-2">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
          </svg>
          <span>สแกน QR เพื่อเพิ่มรายการ</span>
        </button>

        <div id="videoIssueContainer"
             class="relative w-full h-48 bg-gray-200 rounded-lg overflow-hidden hidden mb-4">
          <video id="videoIssue" playsinline class="w-full h-full object-cover"></video>
          <div
            class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-50 text-white text-lg font-bold">
            วาง QR Code ในกรอบ
          </div>
        </div>

        <datalist id="inventoryList"></datalist>
        <ul id="basketIssue" class="space-y-3 mb-4"></ul>

        <!-- Manual input for Issue tab -->
        <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-2 mb-2 items-center">
          <input list="inventoryList" id="manualCodeIssue" placeholder="รหัสหรือชื่อสินค้า"
                 class="flex-1 w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-[#174D27]-light focus:border-[#174D27]-light transition-all duration-200" />
          <div class="flex items-center space-x-2 w-full sm:w-auto">
            <input type="number" id="manualQtyIssue" min="1" value="1"
                   class="w-24 border border-gray-300 rounded-lg p-3 text-center focus:ring-2 focus:ring-[#174D27]-light focus:border-[#174D27]-light transition-all duration-200" />
            <span id="issueCurrentStockDisplay" class="text-sm text-gray-600 whitespace-nowrap"></span>
          </div>
          <button id="addIssueBtn"
                  class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg shadow-md transition-all duration-200 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 w-full sm:w-auto">
            เพิ่ม
          </button>
        </div>

        <button id="submitIssueBtn"
                class="w-full bg-[#174D27] hover:bg-[#000000] text-white mt-4 py-3 rounded-lg shadow-md transition-all duration-200 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-75 flex items-center justify-center disabled:opacity-50 disabled:pointer-events-none"
                disabled>
          <span id="issueBtnText">ยืนยันเบิก (หลายรายการ)</span>
          <span id="issueBtnSpinner" class="spinner ml-2 hidden"></span>
        </button>
      </div>

      <!-- รับเข้า (หลายรายการ) -->
      <div id="tabReceive" class="hidden">
        <div class="text-center mb-6">
          <h2 class="text-2xl font-extrabold text-gray-800">รับเข้าสินค้าหลายรายการ</h2>
          <p class="text-gray-600 mt-2">ผู้รับเข้า: <span id="actorReceive" class="font-semibold text-[#174D27]">–</span></p>
        </div>

        <button id="scanReceiveBtn"
                class="w-full mb-4 bg-[#00317d] hover:bg-[#000000] text-white py-3 rounded-lg shadow-md flex items-center justify-center space-x-2">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
          </svg>
          <span>สแกน QR เพื่อเพิ่มรายการ</span>
        </button>

        <div id="videoReceiveContainer"
             class="relative w-full h-48 bg-gray-200 rounded-lg overflow-hidden hidden mb-4">
          <video id="videoReceive" playsinline class="w-full h-full object-cover"></video>
          <div
            class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-50 text-white text-lg font-bold">
            วาง QR Code ในกรอบ
          </div>
        </div>

        <datalist id="inventoryList2"></datalist>
        <ul id="basketReceive" class="space-y-3 mb-4"></ul>

        <!-- Manual input for Receive tab -->
        <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-2 mb-6 items-center">
          <input list="inventoryList2" id="manualCodeReceive" placeholder="รหัสหรือชื่อสินค้า"
                 class="flex-1 w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-[#174D27]-light focus:border-[#174D27]-light transition-all duration-200" />
          <div class="flex items-center space-x-2 w-full sm:w-auto">
            <input type="number" id="manualQtyReceive" min="1" value="1"
                   class="w-24 border border-gray-300 rounded-lg p-3 text-center focus:ring-2 focus:ring-[#174D27]-light focus:border-[#174D27]-light transition-all duration-200" />
            <span id="receiveCurrentStockDisplay" class="text-sm text-gray-600 whitespace-nowrap"></span>
          </div>
          <button id="addReceiveBtn"
                  class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg shadow-md transition-all duration-200 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 w-full sm:w-auto">
            เพิ่ม
          </button>
        </div>

        <button id="submitReceiveBtn"
                class="w-full bg-[#00317d] hover:bg-[#000000] text-white py-3 rounded-lg shadow-md transition-all duration-200 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-75 flex items-center justify-center disabled:opacity-50 disabled:pointer-events-none"
                disabled>
          <span id="receiveBtnText">ยืนยันรับเข้า (หลายรายการ)</span>
          <span id="receiveBtnSpinner" class="spinner ml-2 hidden"></span>
        </button>
      </div>

      <!-- ประวัติ -->
      <div id="tabHistory" class="hidden">
        <div class="text-center mb-6">
          <h2 class="text-2xl font-extrabold text-gray-800">ประวัติการทำรายการ</h2>
          <p class="text-gray-600 mt-2">รายการล่าสุดของคุณ</p>
        </div>
        <div class="overflow-x-auto bg-white rounded-lg shadow-md mb-4 border border-gray-200">
          <table class="min-w-full text-left">
            <thead class="bg-gray-100 border-b border-gray-200">
              <tr>
                <th class="px-4 py-3 text-sm font-semibold text-gray-700">วันที่/เวลา</th>
                <th class="px-4 py-3 text-sm font-semibold text-gray-700">ประเภท</th>
                <th class="px-4 py-3 text-sm font-semibold text-gray-700">รหัส-ชื่อ</th>
                <th class="px-4 py-3 text-sm font-semibold text-gray-700">จำนวน</th>
              </tr>
            </thead>
            <tbody id="historyTable" class="divide-y divide-gray-100"></tbody>
          </table>
        </div>
        <div class="flex justify-between items-center px-2 py-2">
          <button id="historyPrev"
                  class="px-5 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors duration-200 disabled:opacity-50 disabled:pointer-events-none"
                  disabled>
            <svg class="w-4 h-4 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
            </svg>
            ก่อนหน้า
          </button>
          <span id="historyPageInfo" class="text-sm text-gray-600 font-medium">หน้าที่ 1 จาก 1</span>
          <button id="historyNext"
                  class="px-5 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors duration-200 disabled:opacity-50 disabled:pointer-events-none"
                  disabled>
            ถัดไป
            <svg class="w-4 h-4 inline-block ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // --- Configuration ---
    const LIFF_ID = '2007392451-2Kx53NPb';
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbxetqC2xndc0vB_-FqFOEqGQUgn8Q9TkOw8bMOR7sewqEPlEw55jUHa1t2CtB5igg/exec';

    // Firebase refs (initialized in firebase-config.js)
    const stockRef = db.ref('stock');
    const issueRef = db.ref('issueRecords');
    const receiveRef = db.ref('receiveRecords');
    const employeesRef = db.ref('employees');

    // --- State variables ---
    let userIdLine = '';
    let actorIssue = '';
    let actorReceive = '';
    let basketIssue = [];
    let basketReceive = [];
    let allInventoryItems = {};
    let tempScannedCode = null;
    let historyRecords = [];
    let historyPage = 1;
    const pageSize = 15;

    // --- UI Helper Functions ---
    function showAlert(msg, type = 'error') {
      const el = document.getElementById('customAlert');
      const icon = document.getElementById('alertIcon');
      const text = document.getElementById('alertMessage');
      text.textContent = msg;
      el.classList.remove('success', 'error');
      el.classList.add(type);
      if (type === 'success') {
        icon.innerHTML = '<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>';
      } else {
        icon.innerHTML = '<path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>';
      }
      el.classList.add('show');
      setTimeout(() => el.classList.remove('show'), 3000);
    }

    function setButtonLoading(buttonId, isLoading, originalText) {
      const btn = document.getElementById(buttonId);
      const prefix = buttonId.replace('submit', '').replace('Btn', '').toLowerCase(); // 'issue' or 'receive'
      const textEl = document.getElementById(prefix + 'BtnText'.replace('Btn', 'Text'));
      const spinnerEl = document.getElementById(prefix + 'BtnSpinner'.replace('Btn', 'Spinner'));
      if (!textEl || !spinnerEl) {
        btn.disabled = isLoading;
        return;
      }
      if (isLoading) {
        btn.disabled = true;
        textEl.textContent = 'กำลังส่ง...';
        spinnerEl.classList.remove('hidden');
      } else {
        btn.disabled = false;
        textEl.textContent = originalText;
        spinnerEl.classList.add('hidden');
      }
    }

    function updateBasket(listId, basket, btnId) {
      const ul = document.getElementById(listId);
      ul.innerHTML = basket.map(item => `
        <li class="flex justify-between items-center bg-gray-50 p-3 rounded-lg shadow-sm border border-gray-100">
          <div class="flex-grow">
            <span class="text-sm font-medium text-gray-800">${item.code}</span>
            <span class="block text-md text-gray-700">${item.name} × <span class="font-bold">${item.qty}</span></span>
          </div>
          <button onclick="removeFromBasket('${listId}','${item.code}','${btnId}')" class="text-red-500 text-lg font-bold hover:text-[#000000] transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-red-300 rounded-full px-2">×</button>
        </li>
      `).join('');
      document.getElementById(btnId).disabled = basket.length === 0;
    }

    window.removeFromBasket = (listId, code, btnId) => {
      if (listId === 'basketIssue') {
        basketIssue = basketIssue.filter(x => x.code !== code);
        updateBasket('basketIssue', basketIssue, 'submitIssueBtn');
      } else {
        basketReceive = basketReceive.filter(x => x.code !== code);
        updateBasket('basketReceive', basketReceive, 'submitReceiveBtn');
      }
      showAlert('นำสินค้าออกจากตะกร้าแล้ว', 'success');
    };

    // --- LIFF Initialization ---
    async function liffInit() {
      try {
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) await liff.login();
        const profile = await liff.getProfile();
        userIdLine = profile.userId;

        const snap = await employeesRef.orderByChild('userIdLine').equalTo(userIdLine).get();
        actorIssue = snap.exists() ? Object.values(snap.val())[0].fullName : 'ไม่ทราบชื่อ';
        actorReceive = actorIssue;
        document.getElementById('actorIssue').textContent = actorIssue;
        document.getElementById('actorReceive').textContent = actorReceive;

        const snapStock = await stockRef.once('value');
        snapStock.forEach(ch => {
          const d = ch.val();
          allInventoryItems[d.code] = { name: d.name, quantity: d.quantity || 0 };
          ['inventoryList', 'inventoryList2'].forEach(id => {
            document.getElementById(id).insertAdjacentHTML('beforeend',
              `<option value="${d.code} ‒ ${d.name}" data-code="${d.code}" data-name="${d.name}" data-stock="${d.quantity||0}">
                ${d.code} ‒ ${d.name} (คงเหลือ: ${d.quantity||0})
              </option>`);
          });
        });
      } catch (err) {
        console.error("LIFF init failed:", err);
        showAlert('เกิดข้อผิดพลาดในการเริ่มต้น LIFF: ' + err.message);
      }
    }

    // --- Manual Input Reset ---
    function resetManualInput(key) {
      const codeEl = document.getElementById(`manualCode${key==='issue'?'Issue':'Receive'}`);
      const qtyEl = document.getElementById(`manualQty${key==='issue'?'Issue':'Receive'}`);
      const stockEl = document.getElementById(`${key==='issue'?'issue':'receive'}CurrentStockDisplay`);
      const addBtn = document.getElementById(`add${key==='issue'?'Issue':'Receive'}Btn`);

      codeEl.value = '';
      codeEl.readOnly = false;
      qtyEl.value = '1';
      stockEl.textContent = '';
      addBtn.textContent = 'เพิ่ม';
      tempScannedCode = null;
    }

    // --- Add Item to Basket Logic ---
    async function addItemToBasketLogic(key, code, qty) {
      const item = allInventoryItems[code];
      if (!item) {
        return showAlert(`ไม่พบสินค้า "${code}"`, 'error');
      }
      const currentStock = item.quantity || 0;
      const basket = key === 'issue' ? basketIssue : basketReceive;
      if (key === 'issue' && qty > currentStock) {
        return showAlert(`สินค้า "${item.name}" มีไม่พอ เบิกได้สูงสุด ${currentStock} ชิ้น`, 'error');
      }
      const existing = basket.find(x => x.code === code);
      if (existing) {
        if (existing.qty !== qty) {
          existing.qty = qty;
          showAlert(`อัปเดตจำนวนสินค้า "${item.name}" เป็น ${qty} ชิ้น`, 'success');
        } else {
          showAlert(`สินค้า "${item.name}" จำนวน ${qty} ชิ้น อยู่ในตะกร้าแล้ว`, 'info');
        }
      } else {
        basket.push({ code, name: item.name, qty });
        showAlert(`เพิ่ม "${item.name}" จำนวน ${qty} ชิ้น เข้าตะกร้า`, 'success');
      }
      updateBasket(key==='issue'?'basketIssue':'basketReceive', basket, key==='issue'?'submitIssueBtn':'submitReceiveBtn');
      resetManualInput(key);
    }

    // --- QR Scanner Setup ---
    function setupScan(btnId, videoId, containerId, listKey) {
      document.getElementById(btnId).onclick = async () => {
        const video = document.getElementById(videoId);
        const container = document.getElementById(containerId);
        const codeInput = document.getElementById(`manualCode${listKey==='issue'?'Issue':'Receive'}`);
        const qtyInput = document.getElementById(`manualQty${listKey==='issue'?'Issue':'Receive'}`);
        const stockDisplay = document.getElementById(`${listKey==='issue'?'issue':'receive'}CurrentStockDisplay`);
        const addBtn = document.getElementById(`add${listKey==='issue'?'Issue':'Receive'}Btn`);

        resetManualInput(listKey);

        let stream, scanning = true;
        try {
          stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
          video.srcObject = stream;
          video.play();
          container.classList.remove('hidden');

          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');

          const scanFrame = () => {
            if (!scanning || video.readyState !== video.HAVE_ENOUGH_DATA) {
              if (scanning) requestAnimationFrame(scanFrame);
              return;
            }
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const code = jsQR(imageData.data, imageData.width, imageData.height);
            if (code) {
              scanning = false;
              tempScannedCode = code.data.trim();
              const item = allInventoryItems[tempScannedCode];
              if (item) {
                codeInput.value = `${tempScannedCode} ‒ ${item.name}`;
                codeInput.readOnly = true;
                qtyInput.value = '1';
                updateStockDisplay(`manualCode${listKey==='issue'?'Issue':'Receive'}`, `${listKey==='issue'?'issue':'receive'}CurrentStockDisplay`);
                addBtn.textContent = 'เพิ่ม (สินค้าที่สแกน)';
                showAlert(`สแกนสำเร็จ: ${item.name}`, 'success');
              } else {
                showAlert(`ไม่พบสินค้าสำหรับ QR: ${tempScannedCode}`, 'error');
                resetManualInput(listKey);
              }
              stream.getTracks().forEach(t => t.stop());
              container.classList.add('hidden');
              return;
            }
            requestAnimationFrame(scanFrame);
          };
          scanFrame();
        } catch (err) {
          console.error("Camera error:", err);
          showAlert('ไม่สามารถเข้าถึงกล้องได้', 'error');
          if (stream) stream.getTracks().forEach(t => t.stop());
          container.classList.add('hidden');
          scanning = false;
          resetManualInput(listKey);
        }
      };
    }
    setupScan('scanIssueBtn','videoIssue','videoIssueContainer','issue');
    setupScan('scanReceiveBtn','videoReceive','videoReceiveContainer','receive');

    // --- Stock Display Update ---
    function updateStockDisplay(inputId, displayId) {
      const raw = document.getElementById(inputId).value.trim();
      const display = document.getElementById(displayId);
      display.textContent = '';
      display.classList.remove('text-red-500');
      if (!raw) return;
      const code = raw.split(' ‒ ')[0];
      const item = allInventoryItems[code];
      if (item) {
        const qty = item.quantity||0;
        display.textContent = `(คงเหลือ: ${qty})`;
        if (qty === 0) display.classList.add('text-red-500');
      } else {
        display.textContent = '(ไม่พบสินค้า)';
      }
    }
    document.getElementById('manualCodeIssue').addEventListener('input', () => updateStockDisplay('manualCodeIssue','issueCurrentStockDisplay'));
    document.getElementById('manualCodeReceive').addEventListener('input', () => updateStockDisplay('manualCodeReceive','receiveCurrentStockDisplay'));

    // --- Manual Add Buttons ---
    document.getElementById('addIssueBtn').onclick = async () => {
      let code = tempScannedCode || document.getElementById('manualCodeIssue').value.trim().split(' ‒ ')[0];
      const qty = +document.getElementById('manualQtyIssue').value;
      if (!code || qty<1) return showAlert('กรุณาระบุรหัสและจำนวนให้ถูกต้อง','error');
      await addItemToBasketLogic('issue',code,qty);
    };
    document.getElementById('addReceiveBtn').onclick = async () => {
      let code = tempScannedCode || document.getElementById('manualCodeReceive').value.trim().split(' ‒ ')[0];
      const qty = +document.getElementById('manualQtyReceive').value;
      if (!code || qty<1) return showAlert('กรุณาระบุรหัสและจำนวนให้ถูกต้อง','error');
      await addItemToBasketLogic('receive',code,qty);
    };

    // --- Communicate with GAS ---
    async function postToGAS(action, userFullName, userId, items) {
      const payload = { action, user: userFullName, userId, items };
      const res = await fetch(GAS_URL, {
        method:'POST',
        body: JSON.stringify(payload)
      });
      const j = await res.json();
      if (j.status!=='success') throw new Error(j.message||'GAS error');
    }

    // --- Submit Issue ---
    document.getElementById('submitIssueBtn').onclick = async () => {
      if (!basketIssue.length) return;
      setButtonLoading('submitIssueBtn',true,'ยืนยันเบิก (หลายรายการ)');
      try {
        const now = new Date().toISOString();
        const items = [...basketIssue];
        // Pre-check stock
        for (let it of items) {
          const avail = allInventoryItems[it.code]?.quantity||0;
          if (it.qty>avail) throw new Error(`สินค้า ${it.code} มีไม่พอ เบิกได้สูงสุด ${avail}`);
        }
        // Write to Firebase
        for (let it of items) {
          const key = issueRef.push().key;
          await issueRef.child(key).set({
            id:key, date:now,
            timestamp:firebase.database.ServerValue.TIMESTAMP,
            borrower:actorIssue, userId:userIdLine,
            itemCode:it.code, itemName:it.name, quantity:it.qty
          });
          await stockRef.child(it.code).child('quantity')
            .transaction(c=>(c||0)-it.qty);
          allInventoryItems[it.code].quantity -= it.qty;
        }
        // Notify via GAS (handles both user & admin)
        await postToGAS('issue',actorIssue,userIdLine,items);
        showAlert('เบิกสินค้าเรียบร้อยแล้ว','success');
        basketIssue=[]; updateBasket('basketIssue',[], 'submitIssueBtn');
      } catch (err) {
        console.error(err);
        showAlert(err.message,'error');
      } finally {
        setButtonLoading('submitIssueBtn',false,'ยืนยันเบิก (หลายรายการ)');
      }
    };

    // --- Submit Receive ---
    document.getElementById('submitReceiveBtn').onclick = async () => {
      if (!basketReceive.length) return;
      setButtonLoading('submitReceiveBtn',true,'ยืนยันรับเข้า (หลายรายการ)');
      try {
        const now = new Date().toISOString();
        const items = [...basketReceive];
        for (let it of items) {
          const key = receiveRef.push().key;
          await receiveRef.child(key).set({
            id:key, date:now,
            timestamp:firebase.database.ServerValue.TIMESTAMP,
            borrower:actorReceive, userId:userIdLine,
            itemCode:it.code, itemName:it.name, quantity:it.qty
          });
          await stockRef.child(it.code).child('quantity')
            .transaction(c=>(c||0)+it.qty);
          allInventoryItems[it.code].quantity += it.qty;
        }
        await postToGAS('receive',actorReceive,userIdLine,items);
        showAlert('รับเข้าสินค้าเรียบร้อยแล้ว','success');
        basketReceive=[]; updateBasket('basketReceive',[], 'submitReceiveBtn');
      } catch (err) {
        console.error(err);
        showAlert(err.message,'error');
      } finally {
        setButtonLoading('submitReceiveBtn',false,'ยืนยันรับเข้า (หลายรายการ)');
      }
    };

    // --- Load History ---
    async function loadHistory() {
      try {
        const [rSnap,iSnap] = await Promise.all([receiveRef.once('value'), issueRef.once('value')]);
        const recs = [];
        rSnap.forEach(ch=>{const d=ch.val(); if(d.userId===userIdLine) recs.push({...d,type:'receive'});});
        iSnap.forEach(ch=>{const d=ch.val(); if(d.userId===userIdLine) recs.push({...d,type:'issue'});});
        recs.sort((a,b)=>new Date(b.timestamp||b.date)-new Date(a.timestamp||a.date));
        historyRecords=recs; historyPage=1; renderHistory();
      } catch(err) {
        console.error(err);
        showAlert('ไม่สามารถโหลดประวัติได้','error');
      }
    }

    function renderHistory() {
      const start = (historyPage-1)*pageSize;
      const page = historyRecords.slice(start, start+pageSize);
      const tbody = document.getElementById('historyTable');
      tbody.innerHTML = '';
      if (!page.length) {
        tbody.innerHTML = `<tr><td colspan="4" class="px-4 py-3 text-center text-gray-500">ไม่พบประวัติการทำรายการ</td></tr>`;
      } else {
        for (let d of page) {
          const cls = d.type==='receive'? 'bg-green-50':'bg-red-50';
          const dateStr = new Date(d.timestamp||d.date)
            .toLocaleString('th-TH',{dateStyle:'short',timeStyle:'short'});
          const typeText = d.type==='receive'? 'รับเข้า':'เบิก';
          const color = d.type==='receive'? 'text-green-700':'text-[#000000]';
          tbody.insertAdjacentHTML('beforeend',`
            <tr class="${cls} hover:bg-gray-100 transition-colors duration-150">
              <td class="px-4 py-3 text-sm">${dateStr}</td>
              <td class="px-4 py-3 text-sm font-medium ${color}">${typeText}</td>
              <td class="px-4 py-3 text-sm text-gray-800">${d.itemCode} ‒ ${d.itemName}</td>
              <td class="px-4 py-3 text-sm font-bold text-gray-800">${d.quantity}</td>
            </tr>`);
        }
      }
      const total = Math.max(1, Math.ceil(historyRecords.length/pageSize));
      document.getElementById('historyPageInfo').textContent = `หน้าที่ ${historyPage} จาก ${total}`;
      document.getElementById('historyPrev').disabled = historyPage===1;
      document.getElementById('historyNext').disabled = historyPage===total;
    }

    document.getElementById('historyPrev').onclick = ()=>{ if(historyPage>1){ historyPage--; renderHistory(); }};
    document.getElementById('historyNext').onclick = ()=>{ const t=Math.ceil(historyRecords.length/pageSize); if(historyPage<t){ historyPage++; renderHistory(); } };

    // --- Tab Switching ---
    function activateTab(tab) {
      document.querySelectorAll('.tab-button').forEach(btn=>{
        btn.classList.remove('active','border-[#174D27]','text-[#174D27]','font-semibold');
        btn.classList.add('border-transparent','text-gray-600');
      });
      document.querySelectorAll('#tabIssue,#tabReceive,#tabHistory').forEach(el=>el.classList.add('hidden'));
      if(tab==='issue'){
        document.getElementById('tabIssue').classList.remove('hidden');
        const b=document.getElementById('tabIssueBtn');
        b.classList.add('active','border-[#174D27]','text-[#174D27]','font-semibold');
        b.classList.remove('border-transparent','text-gray-600');
      }
      if(tab==='receive'){
        document.getElementById('tabReceive').classList.remove('hidden');
        const b=document.getElementById('tabReceiveBtn');
        b.classList.add('active','border-[#174D27]','text-[#174D27]','font-semibold');
        b.classList.remove('border-transparent','text-gray-600');
      }
      if(tab==='history'){
        document.getElementById('tabHistory').classList.remove('hidden');
        const b=document.getElementById('tabHistoryBtn');
        b.classList.add('active','border-[#174D27]','text-[#174D27]','font-semibold');
        b.classList.remove('border-transparent','text-gray-600');
        loadHistory();
      }
      resetManualInput('issue');
      resetManualInput('receive');
    }
    document.getElementById('tabIssueBtn').onclick = ()=>activateTab('issue');
    document.getElementById('tabReceiveBtn').onclick = ()=>activateTab('receive');
    document.getElementById('tabHistoryBtn').onclick = ()=>activateTab('history');

    // --- Initialize ---
    liffInit().then(()=>activateTab('issue'));
  </script>
</body>

</html>
