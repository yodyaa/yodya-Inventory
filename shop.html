<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>ระบบคลังสินค้า</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>

 <!-- IMPORTANT: Make sure your firebase-config.js is in the same directory and configured correctly -->
  <script src="firebase-config.js"></script>
  <style>
    /* Custom Alert Styles */
    #customAlert {
      transition: all 0.3s ease-in-out;
      transform: translateX(100%);
      /* Start off-screen to the right */
      opacity: 0;
    }

    #customAlert.show {
      transform: translateX(0);
      /* Slide in */
      opacity: 1;
    }

    #customAlert.success {
      background-color: #10B981;
      /* Green-500 */
    }

    #customAlert.error {
      background-color: #EF4444;
      /* Red-500 */
    }

    /* Spinner animation for loading states */
    .spinner {
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid #fff;
      border-radius: 50%;
      width: 1.5rem;
      height: 1.5rem;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    /* Specific styles for active tab border */
    .tab-button.active {
      background-color: #174D27;
      border-color: #174D27;
      color: #c2dac9;
    }

    /* Style for quantity buttons to group with input */
    .qty-btn {
        @apply bg-gray-200 text-gray-700 px-3 py-3 hover:bg-gray-300 transition-colors duration-200 flex-shrink-0;
        width: 48px; /* Fixed width for consistent button size */
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .qty-btn-left {
        @apply rounded-l-lg;
    }
    .qty-btn-right {
        @apply rounded-r-lg;
    }
  </style>
</head>

<body class="bg-gray-100 flex items-center justify-center p-4">

  <!-- Custom Alert Notification -->
  <div id="customAlert"
    class="fixed top-6 right-6 w-fit max-w-sm text-white px-5 py-3 rounded-lg shadow-xl text-center z-50 flex items-center justify-center space-x-2">
    <svg id="alertIcon" class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
      <!-- Icon will be dynamically updated -->
    </svg>
    <span id="alertMessage"></span>
  </div>

  <div class="w-full max-w-md mx-auto overflow-hidden">
    <!-- Tabs -->
    <div class="flex border-b border-gray-200 bg-gray-50">
      <button id="tabIssueBtn"
        class="tab-button flex-1 py-3 text-center border-b-2 border-[#174D27] active font-semibold text-[#174D27] transition-colors duration-200">เบิก</button>
      <button id="tabReceiveBtn"
        class="tab-button flex-1 py-3 text-center border-b-2 border-transparent text-gray-600 hover:text-[#174D27] hover:border-[#174D27] transition-colors duration-200">รับเข้า</button>
      <button id="tabHistoryBtn"
        class="tab-button flex-1 py-3 text-center border-b-2 border-transparent text-gray-600 hover:text-[#174D27] hover:border-[#174D27] transition-colors duration-200">ประวัติ</button>
    </div>

    <div class="py-6">
      <!-- เบิก (ปรับปรุงใหม่) -->
      <div id="tabIssue">
        <div class="text-center mb-6">
          <h2 class="text-2xl font-extrabold text-gray-800">เบิกสินค้า</h2>
          <p class="text-gray-600 mt-2">ผู้เบิก: <span id="actorIssue" class="font-semibold text-[#174D27]">–</span></p>
        </div>

        <!-- Input Section -->
        <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">ขั้นตอนที่ 1: ระบุสินค้า</label>
            <button id="scanIssueBtn" class="w-full mb-3 bg-gray-700 hover:bg-black text-white py-3 rounded-lg shadow-md flex items-center justify-center space-x-2">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                <span>สแกน QR Code</span>
            </button>

            <div id="videoIssueContainer" class="relative w-full h-48 bg-gray-200 rounded-lg overflow-hidden hidden mb-3">
              <video id="videoIssue" playsinline class="w-full h-full object-cover"></video>
              <div class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-20 text-white text-lg font-bold">วาง QR Code ในกรอบ</div>
            </div>

            <div class="flex items-center text-gray-500 my-2">
                <div class="flex-grow border-t border-gray-300"></div>
                <span class="flex-shrink mx-4 text-sm">หรือกรอกรหัส</span>
                <div class="flex-grow border-t border-gray-300"></div>
            </div>
            
            <input list="inventoryList" id="manualCodeIssue" placeholder="รหัสหรือชื่อสินค้า" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-[#174D27] transition-all duration-200" />
            <datalist id="inventoryList"></datalist>
        </div>

        <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">ขั้นตอนที่ 2: ระบุจำนวน</label>
            <div class="flex items-center space-x-2">
                <div class="flex items-center space-x-0 w-full border border-gray-300 rounded-lg overflow-hidden">
                    <button type="button" id="decreaseQtyIssue" class="qty-btn qty-btn-left">-</button>
                    <input type="number" id="manualQtyIssue" min="1" value="1" class="flex-grow w-20 p-3 text-center focus:ring-0 focus:outline-none border-t-0 border-b-0 border-l border-r border-gray-300" />
                    <button type="button" id="increaseQtyIssue" class="qty-btn qty-btn-right">+</button>
                </div>
                <span id="issueCurrentStockDisplay" class="text-sm text-gray-600 whitespace-nowrap px-2"></span>
            </div>
        </div>

        <!-- Basket for multi-item mode -->
        <div id="issueBasketContainer" class="hidden mb-4">
            <h3 class="text-lg font-semibold text-gray-800 mb-2">รายการที่จะเบิก</h3>
            <ul id="basketIssue" class="space-y-3 p-3 bg-gray-50 rounded-lg border"></ul>
        </div>
        
        <!-- Action Buttons -->
        <div class="space-y-3">
            <button id="submitIssueBtn" class="w-full bg-[#174D27] hover:bg-black text-white py-3 rounded-lg shadow-md transition-all duration-200 flex items-center justify-center disabled:opacity-50 disabled:pointer-events-none">
                <span id="issueBtnText">ยืนยันเบิก</span>
                <span id="issueBtnSpinner" class="spinner ml-2 hidden"></span>
            </button>
            <button id="addToListIssueBtn" class="w-full bg-blue-600 hover:bg-blue-800 text-white py-3 rounded-lg shadow-md transition-all duration-200">
                เพิ่มรายการ (สำหรับเบิกหลายชิ้น)
            </button>
        </div>
      </div>

      <!-- รับเข้า (ปรับปรุงใหม่) -->
      <div id="tabReceive" class="hidden">
          <div class="text-center mb-6">
          <h2 class="text-2xl font-extrabold text-gray-800">รับเข้าสินค้า</h2>
          <p class="text-gray-600 mt-2">ผู้รับเข้า: <span id="actorReceive" class="font-semibold text-[#174D27]">–</span></p>
        </div>

        <!-- Input Section -->
        <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">ขั้นตอนที่ 1: ระบุสินค้า</label>
            <button id="scanReceiveBtn" class="w-full mb-3 bg-gray-700 hover:bg-black text-white py-3 rounded-lg shadow-md flex items-center justify-center space-x-2">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                <span>สแกน QR Code</span>
            </button>

            <div id="videoReceiveContainer" class="relative w-full h-48 bg-gray-200 rounded-lg overflow-hidden hidden mb-3">
              <video id="videoReceive" playsinline class="w-full h-full object-cover"></video>
              <div class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-20 text-white text-lg font-bold">วาง QR Code ในกรอบ</div>
            </div>

            <div class="flex items-center text-gray-500 my-2">
                <div class="flex-grow border-t border-gray-300"></div>
                <span class="flex-shrink mx-4 text-sm">หรือกรอกรหัส</span>
                <div class="flex-grow border-t border-gray-300"></div>
            </div>
            
            <input list="inventoryList2" id="manualCodeReceive" placeholder="รหัสหรือชื่อสินค้า" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-[#174D27] transition-all duration-200" />
            <datalist id="inventoryList2"></datalist>
        </div>

        <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">ขั้นตอนที่ 2: ระบุจำนวน</label>
            <div class="flex items-center space-x-2">
                <div class="flex items-center space-x-0 w-full border border-gray-300 rounded-lg overflow-hidden">
                    <button type="button" id="decreaseQtyReceive" class="qty-btn qty-btn-left">-</button>
                    <input type="number" id="manualQtyReceive" min="1" value="1" class="flex-grow w-20 p-3 text-center focus:ring-0 focus:outline-none border-t-0 border-b-0 border-l border-r border-gray-300" />
                    <button type="button" id="increaseQtyReceive" class="qty-btn qty-btn-right">+</button>
                </div>
                <span id="receiveCurrentStockDisplay" class="text-sm text-gray-600 whitespace-nowrap px-2"></span>
            </div>
        </div>

        <!-- Basket for multi-item mode -->
        <div id="receiveBasketContainer" class="hidden mb-4">
            <h3 class="text-lg font-semibold text-gray-800 mb-2">รายการที่จะรับเข้า</h3>
            <ul id="basketReceive" class="space-y-3 p-3 bg-gray-50 rounded-lg border"></ul>
        </div>
        
        <!-- Action Buttons -->
        <div class="space-y-3">
            <button id="submitReceiveBtn" class="w-full bg-[#00317d] hover:bg-black text-white py-3 rounded-lg shadow-md transition-all duration-200 flex items-center justify-center disabled:opacity-50 disabled:pointer-events-none">
                <span id="receiveBtnText">ยืนยันรับเข้า</span>
                <span id="receiveBtnSpinner" class="spinner ml-2 hidden"></span>
            </button>
            <button id="addToListReceiveBtn" class="w-full bg-blue-600 hover:bg-blue-800 text-white py-3 rounded-lg shadow-md transition-all duration-200">
                เพิ่มรายการ (สำหรับรับเข้าหลายชิ้น)
            </button>
        </div>
      </div>

      <!-- ประวัติ -->
      <div id="tabHistory" class="hidden">
        <div class="text-center mb-6">
          <h2 class="text-2xl font-extrabold text-gray-800">ประวัติการทำรายการ</h2>
          <p class="text-gray-600 mt-2">รายการล่าสุดของคุณ</p>
        </div>
        <div class="overflow-x-auto bg-white rounded-lg shadow-md mb-4 border border-gray-200">
          <table class="min-w-full text-left">
            <thead class="bg-gray-100 border-b border-gray-200">
              <tr>
                <th class="px-4 py-3 text-sm font-semibold text-gray-700">วันที่/เวลา</th>
                <th class="px-4 py-3 text-sm font-semibold text-gray-700">ประเภท</th>
                <th class="px-4 py-3 text-sm font-semibold text-gray-700">รหัส-ชื่อ</th>
                <th class="px-4 py-3 text-sm font-semibold text-gray-700">จำนวน</th>
              </tr>
            </thead>
            <tbody id="historyTable" class="divide-y divide-gray-100"></tbody>
          </table>
        </div>
        <div class="flex justify-between items-center px-2 py-2">
          <button id="historyPrev" class="px-5 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors duration-200 disabled:opacity-50 disabled:pointer-events-none" disabled>
            <svg class="w-4 h-4 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
            ก่อนหน้า
          </button>
          <span id="historyPageInfo" class="text-sm text-gray-600 font-medium">หน้าที่ 1 จาก 1</span>
          <button id="historyNext" class="px-5 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors duration-200 disabled:opacity-50 disabled:pointer-events-none" disabled>
            ถัดไป
            <svg class="w-4 h-4 inline-block ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Configuration constants
    const LIFF_ID = '2007392451-2Kx53NPb'; // Replace with your LIFF ID
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbxetqC2xndc0vB_-FqFOEqGQUgn8Q9TkOw8bMOR7sewqEPlEw55jUHa1t2CtB5igg/exec'; // Replace with your Google Apps Script URL
    const LIFF_WEB_URL = 'https://liff.line.me/2007335399-rmoYp9Md'; // URL ของ LIFF Web App ของคุณเอง (สำหรับปุ่มใน Flex Message)

    // Firebase references (assuming db is initialized in firebase-config.js)
    const stockRef = db.ref('stock');
    const issueRef = db.ref('issueRecords');
    const receiveRef = db.ref('receiveRecords');
    const employeesRef = db.ref('employees');

    // Global state variables
    let userIdLine = '';
    let actorIssue = '';
    let actorReceive = '';
    let basketIssue = [];
    let basketReceive = [];
    let allInventoryItems = {}; // Cache for all inventory items (code -> {name, quantity})
    let tempScannedCode = null;

    let historyRecords = [];
    let historyPage = 1;
    const pageSize = 15;

    // --- UI Helper Functions ---
    const customAlert = document.getElementById('customAlert');
    const alertMessage = document.getElementById('alertMessage');
    const alertIcon = document.getElementById('alertIcon');

    function showAlert(msg, type = 'error') {
      alertMessage.textContent = msg;
      customAlert.classList.remove('success', 'error');
      customAlert.classList.add(type);

      if (type === 'success') {
        alertIcon.innerHTML = `<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>`;
      } else if (type === 'info') {
         alertIcon.innerHTML = `<path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.894.553L7.382 10H7a1 1 0 100 2h.382l-.276.553A1 1 0 008 13v.5a1 1 0 102 0V13a1 1 0 00-1-1h-.382l.276-.553A1 1 0 0012 10a1 1 0 00-1-1h-.5z" clip-rule="evenodd"></path>`;
         customAlert.style.backgroundColor = '#2196F3';
      } else { // error
        alertIcon.innerHTML = `<path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>`;
      }

      customAlert.classList.add('show');
      setTimeout(() => customAlert.classList.remove('show'), 3000);
    }

    function setButtonLoading(buttonId, isLoading, originalText) {
        const button = document.getElementById(buttonId);
        const baseId = buttonId.replace('submit', '');
        const idPrefix = baseId.charAt(0).toLowerCase() + baseId.slice(1);
        const btnText = document.getElementById(`${idPrefix}Text`);
        const btnSpinner = document.getElementById(`${idPrefix}Spinner`);
        if (!btnText || !btnSpinner) return;

        button.disabled = isLoading;
        if (isLoading) {
            btnText.textContent = 'กำลังส่ง...';
            btnSpinner.classList.remove('hidden');
        } else {
            btnText.textContent = originalText;
            btnSpinner.classList.add('hidden');
        }
    }
    
    function updateBasketUI(key) {
        const basket = key === 'issue' ? basketIssue : basketReceive;
        const listId = key === 'issue' ? 'basketIssue' : 'basketReceive';
        const containerId = key === 'issue' ? 'issueBasketContainer' : 'receiveBasketContainer';
        const submitBtnId = key === 'issue' ? 'submitIssueBtn' : 'submitReceiveBtn';
        const btnTextElem = document.getElementById(key === 'issue' ? 'issueBtnText' : 'receiveBtnText');

        const basketContainer = document.getElementById(containerId);
        const basketElement = document.getElementById(listId);
        
        if (basket.length > 0) {
            basketElement.innerHTML = basket.map(it => `
                <li class="flex justify-between items-center bg-white p-3 rounded-lg shadow-sm border border-gray-200">
                    <div class="flex-grow">
                        <span class="text-sm font-medium text-gray-800">${it.code}</span>
                        <span class="block text-md text-gray-700">${it.name} × <span class="font-bold">${it.qty}</span></span>
                    </div>
                    <button onclick="removeFromBasket('${key}','${it.code}')" class="text-red-500 text-lg font-bold hover:text-red-700 p-1 rounded-full">×</button>
                </li>`).join('');
            basketContainer.classList.remove('hidden');
            btnTextElem.textContent = `ยืนยัน${key === 'issue' ? 'เบิก' : 'รับเข้า'} (${basket.length} รายการ)`;
        } else {
            basketContainer.classList.add('hidden');
            btnTextElem.textContent = `ยืนยัน${key === 'issue' ? 'เบิก' : 'รับเข้า'}`;
        }
        document.getElementById(submitBtnId).disabled = false; // Always enabled if called
    }

    window.removeFromBasket = (key, code) => {
      if (key === 'issue') {
        basketIssue = basketIssue.filter(x => x.code !== code);
      } else {
        basketReceive = basketReceive.filter(x => x.code !== code);
      }
      updateBasketUI(key);
      showAlert('นำสินค้าออกจากรายการแล้ว', 'success');
    };

    async function liffInit() {
      try {
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) await liff.login();
        const prof = await liff.getProfile();
        userIdLine = prof.userId;

        const snap = await employeesRef.orderByChild('userIdLine').equalTo(userIdLine).get();
        actorIssue = actorReceive = snap.exists() ? Object.values(snap.val())[0].fullName : 'ไม่ทราบชื่อ';
        document.getElementById('actorIssue').textContent = actorIssue;
        document.getElementById('actorReceive').textContent = actorReceive;

        const snapStock = await stockRef.once('value');
        snapStock.forEach(ch => {
          const d = ch.val();
          allInventoryItems[d.code] = { name: d.name, quantity: d.quantity || 0 };
          ['inventoryList', 'inventoryList2'].forEach(id => {
            document.getElementById(id).insertAdjacentHTML('beforeend',
              `<option value="${d.code} ‒ ${d.name}" data-stock="${d.quantity || 0}"></option>`);
          });
        });
      } catch (err) {
        console.error("LIFF initialization failed: ", err);
        showAlert('เกิดข้อผิดพลาดในการเริ่มต้น LIFF: ' + err.message);
      }
    }

    function resetManualInput(key) {
      document.getElementById(`manualCode${key === 'issue' ? 'Issue' : 'Receive'}`).value = '';
      document.getElementById(`manualQty${key === 'issue' ? 'Issue' : 'Receive'}`).value = '1';
      document.getElementById(`${key === 'issue' ? 'issueCurrentStockDisplay' : 'receiveCurrentStockDisplay'}`).textContent = '';
      tempScannedCode = null;
    }

    function resetFullForm(key) {
        resetManualInput(key);
        if (key === 'issue') {
            basketIssue = [];
        } else {
            basketReceive = [];
        }
        updateBasketUI(key);
    }
    
    function setupScan(btnId, videoId, containerId, key) {
        document.getElementById(btnId).onclick = async () => {
            const video = document.getElementById(videoId);
            const videoContainer = document.getElementById(containerId);
            const manualCodeInput = document.getElementById(`manualCode${key === 'issue' ? 'Issue' : 'Receive'}`);
            let stream = null; let scanning = true;

            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                video.srcObject = stream; video.play();
                videoContainer.classList.remove('hidden');
                const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');

                function scan() {
                    if (!scanning || video.readyState !== video.HAVE_ENOUGH_DATA) { if (scanning) requestAnimationFrame(scan); return; }
                    canvas.width = video.videoWidth; canvas.height = video.videoHeight;
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const codeResult = jsQR(imageData.data, imageData.width, imageData.height);

                    if (codeResult) {
                        scanning = false;
                        const code = codeResult.data.trim();
                        const itemData = allInventoryItems[code];
                        if (itemData) {
                            tempScannedCode = code; // Store for submission logic
                            manualCodeInput.value = `${code} ‒ ${itemData.name}`;
                            updateStockDisplay(`manualCode${key === 'issue' ? 'Issue' : 'Receive'}`, `${key === 'issue' ? 'issueCurrentStockDisplay' : 'receiveCurrentStockDisplay'}`);
                            showAlert(`สแกนสำเร็จ: ${itemData.name}`, 'success');
                        } else {
                            showAlert(`ไม่พบสินค้าสำหรับ QR Code: "${code}"`, 'error');
                        }
                        if (stream) stream.getTracks().forEach(t => t.stop());
                        videoContainer.classList.add('hidden');
                    } else {
                        requestAnimationFrame(scan);
                    }
                }
                scan();
            } catch (err) {
                showAlert('ไม่สามารถเข้าถึงกล้องได้');
                if (stream) stream.getTracks().forEach(t => t.stop());
                videoContainer.classList.add('hidden');
            }
        };
    }
    setupScan('scanIssueBtn', 'videoIssue', 'videoIssueContainer', 'issue');
    setupScan('scanReceiveBtn', 'videoReceive', 'videoReceiveContainer', 'receive');

    function updateStockDisplay(inputElementId, displayElementId) {
        const inputElement = document.getElementById(inputElementId);
        const displayElement = document.getElementById(displayElementId);
        const enteredValue = inputElement.value.trim();
        displayElement.textContent = ''; displayElement.classList.remove('text-red-500');

        if (!enteredValue) return;

        const itemCode = enteredValue.split(' ‒ ')[0];
        const itemData = allInventoryItems[itemCode];
        
        if (itemData) {
            const currentStock = itemData.quantity || 0;
            displayElement.textContent = `(คงเหลือ: ${currentStock})`;
            if (currentStock === 0) displayElement.classList.add('text-red-500');
        } else {
            displayElement.textContent = '(ไม่พบสินค้า)';
        }
    }
    document.getElementById('manualCodeIssue').addEventListener('input', () => updateStockDisplay('manualCodeIssue', 'issueCurrentStockDisplay'));
    document.getElementById('manualCodeReceive').addEventListener('input', () => updateStockDisplay('manualCodeReceive', 'receiveCurrentStockDisplay'));

    function setupQtyButtons(key) {
        const decreaseBtn = document.getElementById(`decreaseQty${key === 'issue' ? 'Issue' : 'Receive'}`);
        const increaseBtn = document.getElementById(`increaseQty${key === 'issue' ? 'Issue' : 'Receive'}`);
        const qtyInput = document.getElementById(`manualQty${key === 'issue' ? 'Issue' : 'Receive'}`);
        decreaseBtn.addEventListener('click', () => qtyInput.value = Math.max(1, (parseInt(qtyInput.value) || 1) - 1));
        increaseBtn.addEventListener('click', () => qtyInput.value = (parseInt(qtyInput.value) || 0) + 1);
    }
    setupQtyButtons('issue');
    setupQtyButtons('receive');

    // --- NEW LOGIC FOR "ADD TO LIST" BUTTONS ---
    document.getElementById('addToListIssueBtn').onclick = () => handleAddItemToList('issue');
    document.getElementById('addToListReceiveBtn').onclick = () => handleAddItemToList('receive');

    function handleAddItemToList(key) {
        const codeInput = document.getElementById(`manualCode${key === 'issue' ? 'Issue' : 'Receive'}`);
        const qtyInput = document.getElementById(`manualQty${key === 'issue' ? 'Issue' : 'Receive'}`);
        const code = codeInput.value.split(' ‒ ')[0].trim();
        const qty = +qtyInput.value;

        if (!code || qty < 1) {
            return showAlert('กรุณาระบุสินค้าและจำนวนให้ถูกต้อง', 'error');
        }
        
        const itemData = allInventoryItems[code];
        if (!itemData) {
            return showAlert(`ไม่พบสินค้า "${code}"`, 'error');
        }
        
        const targetBasket = key === 'issue' ? basketIssue : basketReceive;
        const existingItem = targetBasket.find(x => x.code === code);
        
        if (key === 'issue' && qty > itemData.quantity) {
             return showAlert(`สินค้า "${itemData.name}" มีไม่พอ เบิกได้สูงสุด ${itemData.quantity} ชิ้น`, 'error');
        }
        
        if (existingItem) {
            existingItem.qty = qty; // Update quantity if exists
            showAlert(`อัปเดตจำนวน "${itemData.name}" เป็น ${qty} ชิ้น`, 'success');
        } else {
            targetBasket.push({ code, name: itemData.name, qty });
            showAlert(`เพิ่ม "${itemData.name}" เข้ารายการ`, 'success');
        }
        
        updateBasketUI(key);
        resetManualInput(key);
    }
    
    // --- NOTIFICATION AND FLEX MESSAGE LOGIC (Unchanged) ---
    async function getAdminIds() {
        const snap = await employeesRef.orderByChild('role').equalTo('admin').get();
        const ids = []; snap.forEach(ch => { const u = ch.val().userIdLine; if (u) ids.push(u); });
        return ids;
    }
    
    async function notifyAdmins(action, userFullName, userId, items) {
      const toList = await getAdminIds();
      if (!toList.length) return;
      const simplifiedItems = items.map(item => ({ code: item.code, name: item.name, qty: item.qty }));
      try {
        await fetch(GAS_URL, {
          method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action, user: userFullName, userId, items: simplifiedItems, toList, liffUrl: LIFF_WEB_URL })
        });
      } catch (error) { console.error('Error sending admin notification via GAS:', error); }
    }
    
    function createFlexMessageContent(action, actorName, items) {
      const now = new Date();
      const dateStr = `${now.toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: 'numeric' })} ${now.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit', hour12: false })}`;
      const isIssue = action === 'issue';
      const itemContents = items.map(item => ({
          type: "box", layout: "vertical", spacing: "none", contents: [
            { type: "text", text: `${item.name} (รหัส: ${item.code})`, size: "sm", weight: "bold", wrap: true, color: "#333333" },
            { type: "text", text: `จำนวน: ${item.qty} ชิ้น`, size: "sm", color: isIssue ? "#D32F2F" : "#388E3C", margin: "xs" }]
      }));
      const contentsWithSeparators = [];
      itemContents.forEach((itemBox, index) => {
        contentsWithSeparators.push(itemBox);
        if (index < itemContents.length - 1) contentsWithSeparators.push({ type: "separator", margin: "sm" });
      });
      return { type: "bubble", size: "mega",
        header: { type: "box", layout: "vertical", backgroundColor: isIssue ? "#FDECEA" : "#E8F5E9", paddingAll: "md",
            contents: [{ type: "text", text: isIssue ? "แจ้งเบิกสินค้า" : "แจ้งรับเข้าสินค้า", weight: "bold", size: "md", color: isIssue ? "#D32F2F" : "#388E3C", align: "center" }]
        },
        body: { type: "box", layout: "vertical", spacing: "md", paddingAll: "xl", contents: [
            { type: "box", layout: "baseline", contents: [
                { type: "text", text: isIssue ? "ผู้เบิก:" : "ผู้รับเข้า:", flex: 2, size: "md", color: "#555555" },
                { type: "text", text: actorName, flex: 3, size: "md", weight: "bold", color: "#000000", wrap: true }]
            },
            { type: "box", layout: "baseline", contents: [
                { type: "text", text: "วันที่:", flex: 2, size: "md", color: "#555555" },
                { type: "text", text: dateStr, flex: 3, size: "md", color: "#000000" }]
            },
            { type: "separator", margin: "lg" },
            { type: "text", text: isIssue ? "รายการสินค้าที่เบิก:" : "รายการสินค้าที่รับเข้า:", weight: "bold", size: "lg", color: "#333333", margin: "md" },
            { type: "box", layout: "vertical", contents: contentsWithSeparators, spacing: "md" }]
        }};
    }

    // --- UPDATED SUBMISSION LOGIC ---
    document.getElementById('submitIssueBtn').onclick = async () => {
        // If basket is empty, perform a single-item transaction. Otherwise, process the basket.
        if (basketIssue.length === 0) {
            const code = document.getElementById('manualCodeIssue').value.split(' ‒ ')[0].trim();
            const qty = +document.getElementById('manualQtyIssue').value;
            if (!code || qty < 1) return showAlert('กรุณากรอกข้อมูลสินค้าให้ครบถ้วน', 'error');
            const itemData = allInventoryItems[code];
            if (!itemData) return showAlert(`ไม่พบข้อมูลสินค้าสำหรับรหัส: ${code}`, 'error');
            
            const singleItem = { code, name: itemData.name, qty };
            await processIssue([singleItem]);
        } else {
            await processIssue(basketIssue);
        }
    };

    document.getElementById('submitReceiveBtn').onclick = async () => {
        if (basketReceive.length === 0) {
            const code = document.getElementById('manualCodeReceive').value.split(' ‒ ')[0].trim();
            const qty = +document.getElementById('manualQtyReceive').value;
             if (!code || qty < 1) return showAlert('กรุณากรอกข้อมูลสินค้าให้ครบถ้วน', 'error');
            const itemData = allInventoryItems[code];
            if (!itemData) return showAlert(`ไม่พบข้อมูลสินค้าสำหรับรหัส: ${code}`, 'error');

            const singleItem = { code, name: itemData.name, qty };
            await processReceive([singleItem]);
        } else {
            await processReceive(basketReceive);
        }
    };
    
    async function processIssue(itemsToProcess) {
        setButtonLoading('submitIssueBtn', true, 'ยืนยันเบิก');
        try {
            // Pre-check stock for all items
            for (const item of itemsToProcess) {
                const currentStock = allInventoryItems[item.code] ? allInventoryItems[item.code].quantity : 0;
                if (item.qty > currentStock) {
                    showAlert(`สินค้า "${item.name}" มีไม่พอ (คงเหลือ ${currentStock})`, 'error');
                    setButtonLoading('submitIssueBtn', false, document.getElementById('issueBtnText').textContent);
                    return;
                }
            }
            
            const now = new Date().toISOString();
            for (const it of itemsToProcess) {
              const key = issueRef.push().key;
              await issueRef.child(key).set({ id: key, date: now, timestamp: firebase.database.ServerValue.TIMESTAMP, borrower: actorIssue, userId: userIdLine, itemCode: it.code, itemName: it.name, quantity: it.qty });
              await stockRef.child(it.code).child('quantity').transaction(c => (c || 0) - it.qty);
              if(allInventoryItems[it.code]) allInventoryItems[it.code].quantity -= it.qty;
            }

            const flexMessageBubble = createFlexMessageContent('issue', actorIssue, itemsToProcess);
            await liff.sendMessages([{ type: 'flex', altText: '📤 แจ้งเบิกสินค้า', contents: flexMessageBubble }]);
            await notifyAdmins('issue', actorIssue, userIdLine, itemsToProcess);

            showAlert('เบิกสินค้าเรียบร้อยแล้ว', 'success');
            resetFullForm('issue');
        } catch (error) {
            console.error("Error submitting issue: ", error);
            showAlert('เกิดข้อผิดพลาดในการเบิก: ' + error.message);
        } finally {
            setButtonLoading('submitIssueBtn', false, 'ยืนยันเบิก');
        }
    }

    async function processReceive(itemsToProcess) {
        setButtonLoading('submitReceiveBtn', true, 'ยืนยันรับเข้า');
        try {
            const now = new Date().toISOString();
            for (const it of itemsToProcess) {
              const key = receiveRef.push().key;
              await receiveRef.child(key).set({ id: key, date: now, timestamp: firebase.database.ServerValue.TIMESTAMP, borrower: actorReceive, userId: userIdLine, itemCode: it.code, itemName: it.name, quantity: it.qty });
              await stockRef.child(it.code).child('quantity').transaction(c => (c || 0) + it.qty);
              if(allInventoryItems[it.code]) allInventoryItems[it.code].quantity += it.qty;
            }
            
            const flexMessageBubble = createFlexMessageContent('receive', actorReceive, itemsToProcess);
            await liff.sendMessages([{ type: 'flex', altText: '📥 แจ้งรับเข้าสินค้า', contents: flexMessageBubble }]);
            await notifyAdmins('receive', actorReceive, userIdLine, itemsToProcess);

            showAlert('รับเข้าสินค้าเรียบร้อยแล้ว', 'success');
            resetFullForm('receive');
        } catch (error) {
            console.error("Error submitting receive: ", error);
            showAlert('เกิดข้อผิดพลาดในการรับเข้า: ' + error.message);
        } finally {
            setButtonLoading('submitReceiveBtn', false, 'ยืนยันรับเข้า');
        }
    }

    // --- HISTORY AND TAB LOGIC (Unchanged) ---
    async function loadHistory() { /* ... unchanged ... */ }
    function renderHistory() { /* ... unchanged ... */ }
    document.getElementById('historyPrev').onclick = () => { /* ... unchanged ... */ };
    document.getElementById('historyNext').onclick = () => { /* ... unchanged ... */ };

    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('#tabIssue, #tabReceive, #tabHistory');
    function activateTab(tabName) {
      tabButtons.forEach(btn => {
        btn.classList.remove('active', 'border-[#174D27]', 'text-[#174D27]', 'font-semibold');
        btn.classList.add('border-transparent', 'text-gray-600');
      });
      tabContents.forEach(content => content.classList.add('hidden'));

      if (tabName === 'issue') {
        document.getElementById('tabIssue').classList.remove('hidden');
        document.getElementById('tabIssueBtn').classList.add('active', 'border-[#174D27]', 'text-[#174D27]', 'font-semibold');
        resetFullForm('issue');
      } else if (tabName === 'receive') {
        document.getElementById('tabReceive').classList.remove('hidden');
        document.getElementById('tabReceiveBtn').classList.add('active', 'border-[#174D27]', 'text-[#174D27]', 'font-semibold');
        resetFullForm('receive');
      } else if (tabName === 'history') {
        document.getElementById('tabHistory').classList.remove('hidden');
        document.getElementById('tabHistoryBtn').classList.add('active', 'border-[#174D27]', 'text-[#174D27]', 'font-semibold');
        loadHistory();
      }
    }
    
    // Copy-pasting unchanged history functions for completeness
    async function loadHistory() {
      try {
        const [rSnap, iSnap] = await Promise.all([receiveRef.once('value'), issueRef.once('value')]);
        const recs = [];
        rSnap.forEach(ch => { const d = ch.val(); if (d.userId === userIdLine) recs.push({ ...d, type: 'receive' }); });
        iSnap.forEach(ch => { const d = ch.val(); if (d.userId === userIdLine) recs.push({ ...d, type: 'issue' }); });
        recs.sort((a, b) => (new Date(b.timestamp || b.date)).getTime() - (new Date(a.timestamp || a.date)).getTime());
        historyRecords = recs; historyPage = 1; renderHistory();
      } catch (error) {
        console.error("Error loading history: ", error);
        showAlert('ไม่สามารถโหลดประวัติได้: ' + error.message);
      }
    }
    function renderHistory() {
      const start = (historyPage - 1) * pageSize;
      const page = historyRecords.slice(start, start + pageSize);
      const tbody = document.getElementById('historyTable');
      tbody.innerHTML = ''; 

      if (page.length === 0) {
        tbody.innerHTML = `<tr><td colspan="4" class="px-4 py-3 text-center text-gray-500">ไม่พบประวัติการทำรายการ</td></tr>`;
      } else {
        page.forEach(d => {
          const cls = d.type === 'receive' ? 'bg-green-50' : 'bg-red-50';
          const tr = document.createElement('tr'); tr.className = `${cls} hover:bg-gray-100 transition-colors duration-150`;
          const displayDate = new Date(d.timestamp || d.date).toLocaleString('th-TH', { dateStyle: 'short', timeStyle: 'short' });
          tr.innerHTML = `
            <td class="px-4 py-3 text-sm">${displayDate}</td>
            <td class="px-4 py-3 text-sm font-medium ${d.type === 'receive' ? 'text-green-700' : 'text-red-700'}">${d.type === 'receive' ? 'รับเข้า' : 'เบิก'}</td>
            <td class="px-4 py-3 text-sm text-gray-800">${d.itemCode} ‒ ${d.itemName}</td>
            <td class="px-4 py-3 text-sm font-bold text-gray-800">${d.quantity}</td>`;
          tbody.appendChild(tr);
        });
      }
      const total = Math.max(1, Math.ceil(historyRecords.length / pageSize));
      document.getElementById('historyPageInfo').textContent = `หน้าที่ ${historyPage} จาก ${total}`;
      document.getElementById('historyPrev').disabled = historyPage === 1;
      document.getElementById('historyNext').disabled = historyPage === total;
    }
    document.getElementById('historyPrev').onclick = () => { if (historyPage > 1) { historyPage--; renderHistory(); } };
    document.getElementById('historyNext').onclick = () => { const t = Math.ceil(historyRecords.length / pageSize); if (historyPage < t) { historyPage++; renderHistory(); } };
    
    document.getElementById('tabIssueBtn').onclick = () => activateTab('issue');
    document.getElementById('tabReceiveBtn').onclick = () => activateTab('receive');
    document.getElementById('tabHistoryBtn').onclick = () => activateTab('history');
    liffInit().then(() => activateTab('issue'));
  </script>
</body>

</html>
